<!DOCTYPE html>
<html>
    <head>

        <style>

            .resultheader{
                font-size:12px;
                font-weight:bold;
                text-decoration:underline;
            }
            .expand{
                background-color: rgba(0,0,0,0.1);
                border-radius: 2px;
                padding: 1px 2px 0px 2px;
                border-width: 1px;
                border-style: solid;
                display : inline-block;
                border-color: gray;
            }
            .expandover{
                background-color: rgba(0,0,0,0.2);
                border-color: black;
            }
            .expandclick{
                background-color: rgba(200,0,0,0.4);
                border-color: rgb(100,0,0);
            }

            td{
                text-align : center;
                border-color : black;
            }
            
            table, th, td {
                border: 0px solid black;
                border-collapse: collapse;
            }

            .taskeven{
                background-color : rgb(255,250,245);
                border-color : black;
                
            }
            .taskodd{
                background-color : rgb(245,255,255);
            }
            .instanceeveneven{
                background-color : #BDEBF6;
            }
            .instanceevenodd{
                background-color : #BDE8FF;
            }
            .instanceoddeven{
                background-color : #FAF0E6;
            }
            .instanceoddodd{
                background-color : #FAF5E6;
            }


            .tab{
                background-color : linen;
                padding : 1px 5px 1px 5px;
                border-width : 1px;
                border-color : black;
                border-style : solid;
                border-radius : 4px 4px 1px 1px;
            }

            .sectionHeader{
                background-color : lightblue;
                text-align: center;
                display : block;
            }

            .box {
                font: 10px sans-serif;
            }

            .box line,
            .box rect,
            .box circle {
                fill: #fff;
                stroke: #000;
                stroke-width: 1.5px;
            }

            .box .center {
                stroke-dasharray: 3,3;
            }

            .box .outlier {
                fill: none;
                stroke: #ccc;
            }


        </style>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="d3/d3.min.js"></script>
        <script src="servercomm.js"></script>
        <script src="box.js"></script>
        <script>

            var expandStatId = 0;
            var conditionColors = ["white", "rgb(179,217,250)", "rgb(44,151,224)", "rgb(7,77,101)", "rgb(57,146,131)", "rgb(150,231,154)", "rgb(13,243,143)", "rgb(25,167,31)", "rgb(112,142,48)"];
            var nextColor = 0;
            var condColMatch = [];
            var studyType = "Between";
            var studyName = "";
            
            var rawData = null;
            
            var aggregation = getAggregation("Viewer");

            $(document).ready(function() {
                
                //get study id.
                studyName = getStudyId();
                getTskClss();

                loadResultsData();

            });

            function loadResultsData() {

                //call the server and get the results urls;
                //basic_result
                //accuracy_stats
                //time_stats;

                getResultUrls(studyName, function(resultsUrls, success) {
                    if (success) {
                        //
                        d3.json(resultsUrls.basicResultsUrl, function(error, data) {
                            
                            rawData = data;
                            createMatrixAndPlots(data, function(){                           
                                                                        
                                $('#showResponses').click(function() {
                                    $(".responseFields").toggle(this.checked);
                                });
                                $('#showAccuracyStats').click(function() {
                                    $(".accuracyStatsFields").toggle(this.checked);
                                });
                                $('#showAccuracyGraphs').click(function() {
                                    $(".accuracyGraphFields").toggle(this.checked);
                                });
                                $('#showTimeStats').click(function() {
                                    $(".timeStatsFields").toggle(this.checked);
                                });
                                $('#showTimeGraphs').click(function() {
                                    $(".timeGraphFields").toggle(this.checked);
                                });
                                $('#showTaskInstances').click(function() {
                                    $(".taskInstanceFields").toggle(this.checked);
                                });                                

                                $(".boxplot").hide();
                                $(".barchart").show();                                    
                                $('#graphtype').on('change', function() {                                        
                                    if (this.value === "Bar charts") {                                            
                                        $(".barchart").show();
                                        $(".boxplot").hide();
                                    }
                                    else {
                                        $(".barchart").hide();
                                        $(".boxplot").show();
                                    }
                                });
                                    
                                $("#conditiontype").on('change', function(){
                                    aggregation = getAggregation(this.value);
                                    createMatrixAndPlots(rawData, function(){});
                                    var graphTypeOption = $("#graphtype").val();
                                    if (graphTypeOption === "Bar charts") {                                            
                                        $(".barchart").show();
                                        $(".boxplot").hide();
                                    }
                                    else {
                                        $(".barchart").hide();
                                        $(".boxplot").show();
                                    } 
                                    var taskInstanceOption = $("#showTaskInstances").is(':checked');
                                    alert(taskInstanceOption);
                                    if (taskInstanceOption) $(".taskInstanceFields").show();
                                    else $(".taskInstanceFields").hide();
                                });

                                $(".expand").mouseenter(function() {
                                    $(this).addClass("expandover");
                                });
                                $(".expand").mouseleave(function() {
                                    $(this).removeClass("expandover");
                                });
                                $(".statdetail").hide();
                                $(".expand").click(function(evt) {
                                    $(this).addClass("expandclick");
                                    $(this).animate({opacity: '1'}, 100, function() {
                                        $(this).removeClass("expandclick");
                                        var id = $(this).attr("id");
                                        var split = id.split("_");
                                        if (split[0] === "expandStat") {
                                            $("#stat" + split[1]).toggle();
                                        }
                                        else
                                            expandTask(split[1]);
                                    });

                                    evt.stopImmediatePropagation();
                                });
                            });       
                    });
                    }
                });
            }
            
            function createMatrixAndPlots(data, callback){
                
                nextColor = 0;
                condColMatch = [];
                
                var alltasks = formatTaskData(data.basicResults, aggregation.equal);
                                
                //once this is done, create the display matrix. This will contain svg and div slots
                //in which we will drop the graphs in the next step
                var tests = alltasks[0];
                var entries = alltasks[1];
                var tasks = alltasks[2];
                var exits = alltasks[3];
                
                var which = ["tests","entries","tasks","exits"];
                        
                var html = createMatrix(tests, entries, tasks, exits);
                $("#charts").html(html);

                for (var t = 0; t<alltasks.length; t++){
                    for (var i=0; i<alltasks[t].length; i++){
                        var conditions;
                        var colors; 
                        conditions = alltasks[t][i].conditions;
                        if (t == 2) colors = colorsForConditions(conditions);
                        else colors = colorsForGroups(conditions);

                        if (alltasks[t][i].responseType === "numeric")
                              createBarchart("#slot_response_" + which[t] + "_" + i, 
                                  prepDataForPlot(conditions, function(response) {
                                      return response.response;
                                  }), colors);
                          else
                              createHisto("#slot_response_" + which[t] + "_" + i, 
                                  prepDataForPlot(conditions, function(response) {
                                      return response.response;
                                  }), colors);

                          createBoxplot("#slot_box_accuracy_" + which[t] + "_" + i, 
                              prepDataForPlot(conditions, function(response) {
                                  return response.accuracy;
                              }), colors);
                          createBarchart("#slot_bar_accuracy_" + which[t] + "_" + i, 
                              prepDataForPlot(conditions, function(response) {
                                  return response.accuracy;
                          }), colors);

                          createBoxplot("#slot_box_time_" + which[t] + "_" + i, 
                              prepDataForPlot(conditions, function(response) {
                                  return response.time;
                              }), colors);
                          createBarchart("#slot_bar_time_" + which[t] + "_" + i, 
                              prepDataForPlot(conditions, function(response) {
                                  return response.time;
                              }), colors);                          
                    }
                }                   
                
                callback();
            }
            
            function getAggregation(value){
                if (value === "Viewer"){
                                            aggregation = new Object();
                                            aggregation.equal = function(c1,c2){
                                                if (c1.viewer === c2.viewer) return true;
                                                return false;
                                            }
                                            aggregation.label = function(c){
                                                return c.viewer;
                                            }
                                            aggregation.elements = ["Viewer"];
                                        }
                else if (value === "Data"){
                                            aggregation = new Object();
                                            aggregation.equal = function(c1,c2){
                                                if (c1.dataset === c2.dataset) return true;
                                                return false;
                                            }
                                            aggregation.label = function(c){
                                                return c.dataset;
                                            }
                                            aggregation.elements = ["Data"];
                                        }
                else if (value === "Viewer and data"){
                                            aggregation = new Object();
                                            aggregation.equal = function(c1,c2){
                                                if (c1.viewer === c2.viewer && c1.dataset === c2.dataset)
                                                    return true;
                                                return false;
                                            }
                                            aggregation.label = function(c){
                                                return c.viewer + ", " + c.dataset;
                                            }
                                            aggregation.elements = ["Viewer","Data"];
                }
                return aggregation;

            }


            function getStudyId() {
                var url = window.location.href;
                //alert(url);
                var regexS = "[\\?&]" + "studyName" + "=([^&#]*)";
                var regex = new RegExp(regexS);
                var results = regex.exec(url);
                return results == null ? null : results[1];
            }

            
            function formatTaskData(data, cequal) {
                //cequal is a function; takes two conditions and checks if they are the same
                //it allows us to split results by viewer, data, data x viewer, and, in the future
                //by tasks

                //first, get the standardized test data
                var standardizedTests = [];
                for (var i=0; i<data.length; i++){
                    if (!data[i].taskType.startsWith("test")) continue;
                    
                    var taskIndex = -1;
                    for (var j = 0; j < standardizedTests.length; j++)
                        if (standardizedTests[j].testName === data[i].taskType.substring(4)) {
                            taskIndex = j;
                            break;
                        }

                    if (taskIndex < 0) {
                        standardizedTests.push({testName: data[i].taskType.substring(4), responseType: data[i].responseType, conditions : []});
                             taskIndex = standardizedTests.length - 1;
                    }
                    
                    var test = standardizedTests[taskIndex];

                    var condition = {group: data[i].group, viewer:data[i].viewer, dataset:data[i].dataset};
                    
                    //find the condition that we should merge this record into
                    var conIndex = -1;
                    for (var j=0; j<test.conditions.length; j++)
                        if (test.conditions[j].group === condition.group){
                            conIndex = j;
                            break;
                        }
                                            
                    if (conIndex < 0){
                        //insert the new conditions, but in lexicographical order (this ensures that conditions
                        //are presented in the same order for all tasks
                        var sortIndex =0;
                        for (sortIndex = 0; sortIndex < test.conditions.length; sortIndex++)
                            if (data[i].group.localeCompare(test.conditions[sortIndex].group) < 0)
                                    break;
                            test.conditions.splice(sortIndex, 0, {group: data[i].group, viewer:data[i].viewer, dataset:data[i].dataset, responses : []});
                            conIndex = sortIndex;
                    }
                    
                    for (var j=0; j<data[i].responses.length; j++)
                        test.conditions[conIndex].responses.push(data[i].responses[j][0]);
                    
                        
                };
                
                
                var entryTasks = [];
                for (var i = 0; i < data.length; i++) {
                    if (data[i].taskType !== "entry") continue;
                    
                    var taskIndex = -1;
                    for (var j = 0; j < entryTasks.length; j++)
                        if (entryTasks[j].taskName === data[i].taskName) {
                            taskIndex = j;
                            break;
                        }

                    if (taskIndex < 0) {
                        entryTasks.push({taskName: data[i].taskName, responseType: data[i].responseType, conditions : []});
                        taskIndex = entryTasks.length - 1;
                    }
                    var task = entryTasks[taskIndex];

                    var condition = {viewer:data[i].viewer, dataset:data[i].dataset, group:data[i].group};
                    
                    //find the condition that we should merge this record into
                    var conIndex = -1;
                    for (var j=0; j<task.conditions.length; j++)
                        if (data[i].group === task.conditions[j].group){
                            conIndex = j;
                            break;
                        }
                                            
                    if (conIndex < 0){
                            //insert the new conditions, but in lexicographical order (this ensures that conditions
                            //are presented in the same order for all tasks
                            var sortIndex =0;
                            for (sortIndex = 0; sortIndex < task.conditions.length; sortIndex++)
                                if (data[i].group.localeCompare(task.conditions[sortIndex].group) < 0)
                                    break;
                            task.conditions.splice(sortIndex, 0, {viewer:data[i].viewer, dataset:data[i].dataset, group:data[i].group,responses : []});
                            conIndex = sortIndex;
                    }
                    
                    for (var j=0; j<data[i].responses.length; j++)
                        task.conditions[conIndex].responses.push(data[i].responses[j][0]);
            }
            
            
                var exitTasks = [];
                for (var i = 0; i < data.length; i++) {
                    if (data[i].taskType !== "exit") continue;
                    
                    var taskIndex = -1;
                    for (var j = 0; j < exitTasks.length; j++)
                        if (exitTasks[j].taskName === data[i].taskName) {
                            taskIndex = j;
                            break;
                        }

                    if (taskIndex < 0) {
                        exitTasks.push({taskName: data[i].taskName, responseType: data[i].responseType, conditions : []});
                        taskIndex = exitTasks.length - 1;
                    }
                    var task = exitTasks[taskIndex];

                    var condition = {viewer:data[i].viewer, dataset:data[i].dataset, group:data[i].group};
                    
                    //find the condition that we should merge this record into
                    var conIndex = -1;
                    for (var j=0; j<task.conditions.length; j++)
                        if (data[i].group === task.conditions[j].group){
                            conIndex = j;
                            break;
                        }
                                            
                    if (conIndex < 0){
                            //insert the new conditions, but in lexicographical order (this ensures that conditions
                            //are presented in the same order for all tasks
                            var sortIndex =0;
                            for (sortIndex = 0; sortIndex < task.conditions.length; sortIndex++)
                                if (data[i].group.localeCompare(task.conditions[sortIndex].group) < 0)
                                    break;
                            task.conditions.splice(sortIndex, 0, {viewer:data[i].viewer, dataset:data[i].dataset, group:data[i].group,responses : []});
                            conIndex = sortIndex;
                    }
                    
                    for (var j=0; j<data[i].responses.length; j++)
                        task.conditions[conIndex].responses.push(data[i].responses[j][0]);
            }
 
                       
                
                //finally, get all other tasks; split by conditions (use cequal); aggregate instances      
                var tasks = [];
                for (var i = 0; i < data.length; i++) {
                    if (data[i].taskType !== "task") continue;
                    
                    var addHelper = function(dataRow, aggreg){
                    
                        var taskIndex = -1;
                        for (var j = 0; j < tasks.length; j++)
                            if (tasks[j].taskName === dataRow.taskName) {
                                taskIndex = j;
                                break;
                            }

                        if (taskIndex < 0) {
                            tasks.push({taskName: dataRow.taskName, responseType: dataRow.responseType, conditions : [], aggregated:aggreg});
                             taskIndex = tasks.length - 1;
                        }
                        var task = tasks[taskIndex];

                        var condition = {viewer:dataRow.viewer, dataset:dataRow.dataset};
                    
                        //find the condition that we should merge this record into
                        var conIndex = -1;
                        for (var j=0; j<task.conditions.length; j++)
                            if (cequal(task.conditions[j], condition)){
                                conIndex = j;
                                break;
                            }
                                            
                        if (conIndex < 0){
                            //insert the new conditions, but in lexicographical order (this ensures that conditions
                            //are presented in the same order for all tasks
                            var sortIndex =0;
                            for (sortIndex = 0; sortIndex < task.conditions.length; sortIndex++)
                                if (dataRow.viewer.localeCompare(task.conditions[sortIndex].viewer) < 0 ||
                                        dataRow.dataset.localeCompare(task.conditions[sortIndex].dataset) < 0)
                                    break;
                            task.conditions.splice(sortIndex, 0, {viewer:dataRow.viewer, dataset:dataRow.dataset, responses : []});
                            conIndex = sortIndex;
                        }
                    
                        
                        for (var j=0; j<dataRow.responses.length; j++){
                            var avAcc = 0.;
                            var avTm = 0.;
                            for (var k=0; k<dataRow.responses[j].length; k++){
                                avAcc += dataRow.responses[j][k].accuracy;
                                avTm += dataRow.responses[j][k].time;
                            }
                            avAcc /= dataRow.responses[j].length;
                            avTm /= dataRow.responses[j].length;
                            
                            var avResp = "na";
                            if (!aggreg) avResp = dataRow.responses[j][0].response; 
                            task.conditions[conIndex].responses.push({response:avResp, accuracy:avAcc, time:avTm});
                        }
                    };
                    
                    addHelper(data[i], true); //this adds the aggregated task! (true==aggregated)
                    
                    //can we add individual task instances?
                    if (aggregation.elements.indexOf("Data") >= 0){//yes
                        for (var j=0; j<data[i].responses[0].length; j++){ //go through all instances
                            var instanceResponses = [];
                            for (var k=0; k<data[i].responses.length; k++)
                                instanceResponses.push([data[i].responses[k][j]]);
                            var instanceRow = {taskName:data[i].taskName+"_"+(j+1), responseType:data[i].responseType,
                                viewer:data[i].viewer, dataset:data[i].dataset, responses:instanceResponses};
                            addHelper(instanceRow, false);  //false=instacne
                        }
                    }
            }
            
            
            
            return [standardizedTests, entryTasks, tasks, exitTasks];
        }


            function expandTask(task) {
                $(".instance." + task).toggle();
            }

            function prepDataForPlot(conditions, f) {
                var r = [];
                for (var i = 0; i < conditions.length; i++) {
                   // alert("condition " + i + " " + conditions[i].responses.length + " resps");
                    var rc = [];
                    for (var j=0; j<conditions[i].responses.length; j++){
                        var what = f(conditions[i].responses[j]);                   
                        rc.push(what);
                    }
                    r.push(rc);
                }
                //alert("prep data for plot: " + conditions.length + "\n" + r.length + "\n" + r);
                return r;
            }

            function getTskClss(i) {
                return i % 2 == 0 ? "taskeven" : "taskodd";
            }
            function getInstClss(i, j) {
                return (i % 2 == 0 ? (j % 2 == 0 ? "instanceeveneven" : "instanceevenodd") : (j % 2 == 0 ? "instanceoddeven" : "instanceoddodd"));
            }

            function createMatrix(tests, entries, tasks, exits) {
               // alert("cm: " + tests.length);

                var html = "<table style='border-color:black'>";

                //task names
                html = createRowTaskNames(tests, entries, tasks, exits, html);

                //conditions
                html = createRowConditions(tests, entries, tasks, exits, html);

                //responses (for instances, nothing for everything else)
                html = createRowResponses(tests, entries, tasks, exits, html);


                //accuracy stats (for summaries, nothing for everything else)
               // html = createRowStats(tasks, html, "accuracy");

                //boxplot and barchart accuracy slots for summaries
                html = createRowGraphs(tests, entries, tasks, exits, html, "accuracy");

              //  html = createRowStats(tasks, html, "time");

                html = createRowGraphs(tests, entries, tasks, exits, html, "time");

                return html;
            }

            function createRowTaskNames(tests, entries, tasks, exits, html) {
                html += "<tr>";
                var cnt = 0;
                for (var i = 0; i < tests.length; i++){
                    html += "<td class='" + getTskClss(cnt) + "' colspan=" + tests[i].conditions.length + ">" + tests[i].testName + "</td>";
                    cnt++;
                }
                for (var i = 0; i < entries.length; i++){
                    html += "<td class='" + getTskClss(cnt) + "' colspan=" + entries[i].conditions.length + ">" + entries[i].taskName + "</td>";
                    cnt++;
                }
                for (var i = 0; i < tasks.length; i++){
                    var cls = getTskClss(cnt) + (tasks[i].aggregated ? "" : " taskInstanceFields");
                    html += "<td class='" + cls + "' colspan = " + tasks[i].conditions.length + ">" + tasks[i].taskName + "</td>";                
                    cnt++;
                }
                for (var i = 0; i < exits.length; i++){
                    html += "<td class='" + getTskClss(cnt) + "' colspan=" + exits[i].conditions.length + ">" + exits[i].taskName + "</td>";
                    cnt++;
                }
                html += "</tr>";
               // alert("html: " + html);
                return html;
            }

            function createRowConditions(tests, entries, tasks, exits, html) {
                html += "<tr>";
                var cnt=0;
               for (var i = 0; i < tests.length; i++){
                   for (var j=0; j<tests[i].conditions.length; j++){
                       var label = tests[i].conditions[j].group.substring(0,tests[i].conditions[j].group.indexOf("_"));
                       var col = conditionColors[parseInt(label)];
                       html += "<td class='" + getTskClss(cnt) + "'>" +
                               "<div style='margin:5px 5px 5px 5px; background-color:" + col + "'>"  +  "gr" + label + "</div></td>";
                   }
                   cnt++;
               }
               
               for (var i = 0; i < entries.length; i++){
                   for (var j=0; j<entries[i].conditions.length; j++){
                       var label = entries[i].conditions[j].group.substring(0,entries[i].conditions[j].group.indexOf("_"));
                       //alert("entry label " + j + " " + label);
                       var col = conditionColors[parseInt(label)];
                       html += "<td class='" + getTskClss(cnt) + "'>" +
                               "<div style='margin:5px 5px 5px 5px; background-color:" + col + "'>"  +  "gr" + label + "</div></td>";
                   }
                   cnt++;
               }

                for (var i = 0; i < tasks.length; i++) {
                    for (var j=0; j<tasks[i].conditions.length; j++){
                        var col = getConditionColor(tasks[i].conditions[j]);
                        var cls = getTskClss(cnt) + (tasks[i].aggregated ? "" : " taskInstanceFields");
                        html += "<td class='"+ cls + 
                                "'><div style='margin:5px 5px 5px 5px; background-color:" + col + "'>" 
                                + aggregation.label(tasks[i].conditions[j]) + "</div></td>";                  
                    }
                    cnt++;  
                }
               for (var i = 0; i < exits.length; i++){
                   for (var j=0; j<exits[i].conditions.length; j++){
                       var label = exits[i].conditions[j].group.substring(0,exits[i].conditions[j].group.indexOf("_"));
                       var col = conditionColors[parseInt(label)];
                       html += "<td class='" + getTskClss(cnt) + "'>" +
                               "<div style='margin:5px 5px 5px 5px; background-color:" + col + "'>"  +  "gr" + label + "</div></td>";
                   }
                   cnt++;
               }
                
                html += "</tr>";
                return html;
            }

            function createRowResponses(tests, entries, tasks, exits, html) {
                html += "<tr>";
                
                var createResponseCell = function(naMessage, which, i, cls, nrConditions){
                    if (naMessage != null)
                        return "<td title='" + naMessage + "' colspan=" + nrConditions + " class='"+ cls + "'>NA</td>";
                    
                    var width = Math.max(nrConditions * 100, 250);
                    var ret = "";
                    ret += "<td class='" + cls + "' colspan=" + nrConditions + "><div class='responseFields'>" + 
                                    "<div class=resultheader>responses</div>" + 
                                    "<svg style='width:" + width + "px'" +
                                        "id=slot_response_" + which + "_" + i + ">" + 
                                    "</svg>" + 
                            "</div></td>";
                    return ret;  
                };
                var cnt = 0;
                for (var i = 0; i < tests.length; i++){
                   html += createResponseCell(null,"tests", i, getTskClss(cnt), tests[i].conditions.length);cnt++;}
                
                for (var i = 0; i < entries.length; i++){
                   html += createResponseCell(null,"entries", i, getTskClss(cnt),  entries[i].conditions.length); cnt++;}
                
                for (var i = 0; i < tasks.length; i++){
                   var cls = getTskClss(cnt) + (tasks[i].aggregated ? "" : " taskInstanceFields"); 
                   html += createResponseCell(tasks[i].aggregated ? "Aggregated result; cannot show individual responses." : null, 
                                "tasks", i, cls, tasks[i].conditions.length);cnt++;}
                
                for (var i = 0; i < exits.length; i++){
                   html += createResponseCell(null, "exits", i, getTskClss(cnt),  exits[i].conditions.length); cnt++;
               }
                html += "</tr>";
                return html;
            }

           /* function createRowStats(tasks, html, accurtime) {
                html += "<tr>";
                for (var i = 0; i < tasks.length; i++) {
                    var stats = (accurtime === "accuracy" ? tasks[i].stats : tasks[i].timeStats);
                    if (tasks[i].instances.length == 1) {
                        if (tasks[i].taskType === "task")
                            html += "<td colspan=" + tasks[i].instances[0].conditions.length + " class=" + getTskClss(i) + "><div class='" + accurtime + "StatsFields'><div class=resultheader>" + accurtime + "(stats)</div>" + processStats(tasks[i], stats) + "</div></td>";
                        else
                            html += "<td colspan=" + tasks[i].instances[0].conditions.length + " class=" + getTskClss(i) + "><div class='" + accurtime + "StatsFields'><div class=resultheader>" + accurtime + "(stats)</div>N/A</div></td>";
                    }
                    else {
                        html += "<td colspan=" + tasks[i].conditions.length + " class=" + getTskClss(i) + "><div class='" + accurtime + "StatsFields'><div class=resultheader>" + accurtime + "(stats)</div>" + processStats(tasks[i], stats) + "</div></td>";
                        for (var j = 0; j < tasks[i].instances.length; j++)
                            html += "<td colspan=" + tasks[i].instances[j].conditions.length + " class=" + getInstClss(i, j) + "><div class='" + accurtime + "StatsFields'><div class='instance " + tasks[i].name + "'><div class=resultheader>" + accurtime + "(stats)</div>N/A</div></div></td>";
                    }
                }
                html += "</tr>";
                return html;
            }*/

            function createRowGraphs(tests, entries, tasks, exits, html, accurtime) {
                
                var h = "";
                h += "<tr>";
                
                var createGraphCell = function(naMessage, accurtime, which, i, cls, nrConditions){
                    if (naMessage != null){
                        return "<td title='" + naMessage + "' colspan=" + nrConditions + " class='" + cls + "'>NA</td>";
                    }
                    var ret = "";
                    var width = Math.max(nrConditions * 100, 250);
                    ret += "<td class='" + cls + "' colspan='" + nrConditions + "'><div class='" + accurtime + "GraphFields'>" +
                                    "<div class=resultheader>" + accurtime + "</div>" +
                                    "<div class='boxplot' style='width:" + width + "px' id=slot_box_" + accurtime + "_" + which + "_" + i + "></div>" + 
                                    "<svg class='barchart' style='width:" + width + "px' height='200px' id=slot_bar_" + accurtime + "_" + which + "_" + i + "></svg>" + 
                            "</td>";
 
                    return ret;  
                };
                var cnt = 0;
                for (var i = 0; i < tests.length; i++){
                    if (accurtime === "accuracy")
                        h += createGraphCell((tests[i].conditions[0].responses[0].accuracy < 0) ? "Accuracy was not collected for this task." : null, 
                                       accurtime, "tests", i,getTskClss(cnt), tests[i].conditions.length);
                    else               
                        h += createGraphCell(null,accurtime, "tests", i, getTskClss(cnt), tests[i].conditions.length);

                   cnt++;
               }
                
                for (var i = 0; i < entries.length; i++){
                   if (accurtime === "accuracy")
                       h += createGraphCell((entries[i].conditions[0].responses[0].accuracy < 0) ? "Accuracy was not collected for this task." : null, 
                   accurtime, "entries", i,getTskClss(cnt), entries[i].conditions.length);
                    else
                       h += createGraphCell(null, accurtime, "entries", i,getTskClss(cnt), entries[i].conditions.length);
                    cnt++;
               }
                               
                for (var i = 0; i < tasks.length; i++){
                    
                    var cls = getTskClss(cnt) + (tasks[i].aggregated ? "" : " taskInstanceFields");
                    if (accurtime === "accuracy")
                        h += createGraphCell((tasks[i].conditions[0].responses[0].accuracy < 0) ? "Accuracy was not collected for this task." : null,
                           accurtime, "tasks", i, cls, tasks[i].conditions.length);
                    else
                        h += createGraphCell(null,accurtime, "tasks", i, cls, tasks[i].conditions.length);
                    cnt++
                }
                
                for (var i = 0; i < exits.length; i++){
                   if (accurtime === "accuracy")
                       h += createGraphCell((exits[i].conditions[0].responses[0].accuracy < 0) ? "Accuracy was not collected for this task." : null, 
                   accurtime, "exits", i, getTskClss(cnt), entries[i].conditions.length);
                   else
                       h += createGraphCell(null, accurtime, "exits", i, getTskClss(cnt), entries[i].conditions.length);
                   cnt++;
                }
               
                h += "</tr>";
              //  alert(h);
                html += h;
                return html;
            }

 /*           function createRowEmpty(tasks, html) {
                html += "<tr>";
                var totalCol = 0;
                for (var i = 0; i < tasks.length; i++) {
                    var nrcol1 = tasks[i].instances.length + 1;
                    if (tasks[i].instances.length == 1)
                        nrcol1 = 1;
                    for (var j = 0; j < nrcol1; j++) {
                        var cond = null;
                        if (tasks[i].instances.length > 1 && j == 0)
                            totalCol += tasks[i].conditions.length;
                        else if (tasks[i].instances.length == 1)
                            totalCol += tasks[i].instances[j].conditions.length;
                        else
                            totalCol += tasks[i].instances[j - 1].conditions.length;
                    }
                }
                html += "<td colspan=" + totalCol + "><div style='height:20px'></div></td></tr>";

                return html;
            }*/

            function getConditionColor(cond) {
                var retCol = null;
                for (var i = 0; i < condColMatch.length; i++)
                    if (aggregation.equal(condColMatch[i].condition,cond))
                        return condColMatch[i].color;
                if (retCol == null)
                    condColMatch.push({condition : cond, color: conditionColors[nextColor++]});
                return condColMatch[condColMatch.length - 1].color;
            }

            function colorsForConditions(conds) {
                var res = [];
                for (var i = 0; i < conds.length; i++)
                    res.push(getConditionColor(conds[i]));
                return res;
            }
            function colorsForGroups(conds){
                var res = [];
                for (var i=0; i<conds.length; i++){
                   // alert("hh:" + conds[i].group);
                    var index = conds[i].group.substr(0, conds[i].group.indexOf("_"));
                    res.push(conditionColors[parseInt(index)]);
                }
                return res;
            }
            function processStats(task, stats) {

                if (stats == null)
                    return "Null stats";

                var res = "<div style='font-size:12px; text-align:left'>";

                res += "<div style='margin-bottom:10px'>";
                if (studyType === "Within")
                    res += "A total of " + task.conditions[0].accuracies.length + " participants completed this task in " + (task.conditions.length == 1 ? "one condition." : ("all " + task.conditions.length) + "conditions");
                else if (studyType === "Between") {
                    res += "A total of " + d3.sum(task.conditions, function(d) {
                        return d.accuracies.length
                    }) + " participants solved this task. Each participant solved the task in a single condition."
                    for (var i = 0; i < task.conditions.length; i++)
                        res += "<div style='margin-top:2px; margin-left:10px'>" + formatCondition(task.conditions[i].viewer, task.conditions[i].dataset) + " : " + task.conditions[i].accuracies.length + " participants</div>";
                }
                res += "</div>";


                var normdetail = "<div class=statdetail id='stat" + expandStatId + "'>&nbspShapiro Wilk: <br>";
                var normal = true;
                for (var i = 0; i < stats.normality.length; i++) {
                    normdetail += "<div style='margin-left:10px; margin-top:2px'>" + formatCondition(stats.normality[i].viewer, stats.normality[i].dataset) + " : " + (stats.normality[i].p < 0.05 ? "not norm. distrib." : "norm. distrib.") + "(p=" + stats.normality[i].p + ")</div>";
                    if (stats.normality[i].condition < 0.05)
                        normal = false;
                }
                normdetail += "</div>";

                res += "<div  style='margin-bottom:10px'>"
                if (normal)
                    res += "The data is normally distributed. <span class=expand id='expandStat_" + (expandStatId++) + "'>...</span>" + normdetail;
                else
                    res += "The data is  not normally distributed. <span class=expand id='expandStat_" + (expandStatId++) + "'>...</span>" + normdetail;
                res += "</div>";

                res += "<div  style='margin-bottom:10px'> Overall, the differences in the means shown in the charts below are statistically " + (stats.comparative.outputs[0] < 0.05 ? (" signficant with " + stringForEffectSize(stats.comparative.outputs[1]) + " effect size.") : "  not significant.") + " <span class='expand' id='expandStat_" + expandStatId + "'>...</span>";
                res += "<div class=statdetail id='stat" + (expandStatId++) + "'>" + stringForStatType(stats.comparative) + "</div></div>";

                if (stats.posthoc != null) {
                    res += "<div style='margin-bottom:10px'>";
                    res += "Specifically, a posthoc Mann-Whitney analysis (with Bonferoni correction) shows";
                    var diff = false;
                    for (var i = 0; i < stats.posthoc.results.length; i++)
                        if (stats.posthoc.results[i].outputs[0] < 0.05)
                            diff = true;

                    if (diff) {
                        res += " statistically significant differences between these conditions: <br>";
                        for (var i = 0; i < stats.posthoc.results.length; i++)
                            if (stats.posthoc.results[i].outputs[0] < 0.05)
                                res += "<div style='margin-left:10px; margin-top:2px'>" + formatCondition(stats.posthoc.results[i].viewer1, stats.posthoc.results[i].dataset1) + " and " + formatCondition(stats.posthoc.results[i].viewer2, stats.posthoc.results[i].dataset2) + ": (p=" + stats.posthoc.results[i].outputs[0] + ", r=" + stats.posthoc.results[i].outputs[1] + ", Z=" + stats.posthoc.results[i].outputs[2] + ")<br></div>";
                    }
                    else
                        res += " no statistically significant differences between conditions";
                    res += "</div>";
                }

                res += "</div>";
                return res;
            }

            function formatCondition(v, d) {
                return "(" + v + ", " + d + ")";
            }
            function stringForEffectSize(r) {
                if (r <= 0.2)
                    return "small";
                if (r >= 0.8)
                    return "large";
                return "medium";
            }

            function stringForStatType(stat) {
                var res = stat.test + ":<br>";

                if (stat.test === "t-test")
                    return "&nbsp T-test <br> &nbsp&nbsp&nbsp t(" + stat.outputs[3] + ")=" + stat.outputs[2] + ", r=" + stat.outputs[1] + ", p=" + stat.outputs[0];
                else if (stat.test = "wilcoxon rank sum")
                    return "&nbsp Wilcoxon rank sum <br>&nbsp&nbsp&nbsp Z=" + stat.outputs[2] + ", r=" + stat.outputs[1] + ", p=" + stat.outputs[0];
                return res;
            }


            function createBoxplot(div, data, cols) {
               // alert("div boxplot " + div + "\n" + $(div)[0]);
               if ($(div).length == 0)
                   return;

                if (typeof $(div).css("width") == 'undefined') {
                    return;
                }

                var conditionWidth = parseInt($(div).css("width").replace("px", "")) / data.length;

                var min = Infinity;
                var max = -Infinity;
                for (var i = 0; i < data.length; i++) {
                    var mxc = d3.max(data[i], function(d) {
                        return +d
                    });
                    var mnc = d3.min(data[i], function(d) {
                        return +d
                    });
                    if (mxc > max)
                        max = mxc;
                    if (mnc < min)
                        min = mnc;
                }

                var margin = {top: 10, right: 40, bottom: 10, left: 40},
                width = conditionWidth - margin.left - margin.right,
                        height = 300 - margin.top - margin.bottom;


                //$(div).css("width",(conditionWidth * data.length) + "px");

                var chart = d3.box(cols)
                        .whiskers(iqr(1.5))
                        .width(width)
                        .height(height);

                chart.domain([min, max]);

                var div = d3.select(div)
                        .attr("width", conditionWidth * data.length)
                        .attr("height", height);

                var svg = div.selectAll("svg")
                        .data(data)
                        .enter().append("svg")
                        .attr("class", "box")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.bottom + margin.top)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                        .call(chart);
            }


            function createBarchart(svg, data, cols) {                
                
                if ($(svg).length == 0)
                    return;
                
                var conditionWidth = parseInt($(svg).css("width").replace("px", "")) / data.length;
                
                var derivedData = [];
                for (var i = 0; i < data.length; i++) {
                    var av = d3.mean(data[i]);
                    var stde = d3.deviation(data[i]) / Math.sqrt(1.0 * data[i].length);
                    if (data[i].length == 1) stde = 0;
                    derivedData.push({value: av, stderr: stde});
                }
               // alert("dd: " + derivedData[0].value + " " + derivedData[0].stderr);
                           
                var barWidth = conditionWidth,
                height = 200;
              
              
                var y = d3.scaleLinear()
                        .range([height, 0]);

                var chart = d3.select(svg)
                        .attr("height", "200px");
                
                var mx = d3.max(derivedData, function(d) {
                        return d.value + d.stderr;
                    });
               // alert(mx);
                if (mx === 0) mx = 1;

                y.domain([0, mx]);
                

                var bar = chart.selectAll("g")
                        .data(derivedData)
                        .enter().append("g")
                        .attr("transform", function(d, i) {
                            return "translate(" + (i * barWidth) + ",0)";
                        });

                bar.append("rect")
                        .attr("y", function(d) {
                            return y(d.value);
                        })
                        .attr("x", 10)
                        .attr("height", function(d) {
                            return height - y(d.value);
                        })
                        .attr("fill", function(d, i) {
                            return cols[i];
                        })
                        .attr("stroke", "black")
                        .attr("stroke-width", "2")
                        .attr("width", barWidth - 20);

                bar.append("line")
                        .attr("y1", function(d) {
                            return y(d.value - d.stderr);
                        })
                        .attr("y2", function(d) {
                            return y(d.value + d.stderr);
                        })
                        .attr("x1", barWidth / 2)
                        .attr("x2", barWidth / 2)
                        .attr("stroke-width", "1")
                        .attr("stroke", "gray");

                bar.append("line")
                        .attr("y1", function(d) {
                            return y(d.value - d.stderr);
                        })
                        .attr("y2", function(d) {
                            return y(d.value - d.stderr);
                        })
                        .attr("x1", 0.25 * barWidth)
                        .attr("x2", 0.75 * barWidth)
                        .attr("stroke-width", "1")
                        .attr("stroke", "gray");

                bar.append("line")
                        .attr("y1", function(d) {
                            return y(d.value + d.stderr);
                        })
                        .attr("y2", function(d) {
                            return y(d.value + d.stderr);
                        })
                        .attr("x1", 0.25 * barWidth)
                        .attr("x2", 0.75 * barWidth)
                        .attr("stroke-width", "1")
                        .attr("stroke", "gray");

                bar.append("text")
                        .attr("x", 12)
                        .attr("y", function(d) {
                            return y(d.value) + 3;
                        })
                        .attr("dy", ".75em")
                        .attr("font-size", "11px")
                        .text(function(d) {
                            return d3.format(",.2f")(d.value);
                        });
            }



            function createHisto(svg, data, cols) {

                //create a frequency table
                var freq = [];
                for (var i = 0; i < data.length; i++) {
                    for (var j = 0; j < data[i].length; j++) {
                        var resp = data[i][j];
                        var cond = i;

                        var f = null;
                        for (var k = 0; k < freq.length; k++) {
                            if (resp === freq[k].response)
                                f = freq[k];
                        }

                        if (f == null) {
                            f = {response: resp, conditionFreq: []};
                            for (var l = 0; l < data.length; l++)
                                f.conditionFreq.push(0);
                            freq.push(f);
                        }

                        f.conditionFreq[i]++;
                    }
                }

                for (var i = 0; i < freq.length; i++) {
                    var mx = d3.max(freq[i].conditionFreq);
                    freq[i].max = mx;
                }

                //sort the frequency table by max over conditionFreq
                freq.sort(function(a, b) {
                    return b.max - a.max;
                });


                var height = 200;
                var barWidth = 12;
                var responseWidth = data.length * barWidth + 10;
                var width = freq.length * responseWidth;



                var y = d3.scaleLinear()
                        .range([height, 15]);

                var chart = d3.select(svg)
                        .attr("height", height);

                y.domain([0, freq[0].max]);

                var bar = chart.selectAll("g")
                        .data(freq)
                        .enter().append("g")
                        .attr("transform", function(d, i) {
                            return "translate(" + (i * responseWidth) + ",0)";
                        });


                for (var i = 0; i < data.length; i++) {
                    bar.append("rect")
                            .attr("y", function(d) {
                                return d.conditionFreq[i] == 0 ? height - 16 : y(d.conditionFreq[i]);
                            })
                            .attr("x", i * barWidth)
                            .attr("fill", cols[i])
                            .attr("height", function(d) {
                                return d.conditionFreq[i] == 0 ? 1 : height - y(d.conditionFreq[i]) - 15;
                            })
                            .attr("stroke", "gray")
                            .attr("stroke-width", "1")
                            .attr("width", barWidth - 2);

                    bar.append("text")
                            .attr("x", i * barWidth + 2)
                            .attr("y", function(d) {
                                return d.conditionFreq[i] == 0 ? height - 26 : y(d.conditionFreq[i]) + 2;
                            })
                            .attr("width", responseWidth)
                            .attr("dy", ".75em")
                            .attr("font-size", "11px")
                            .text(function(d) {
                                return d.conditionFreq[i];
                            });
                }

                bar.append("text")
                        .attr("x", 0)
                        .attr("y", height - 10)
                        .attr("dy", ".75em")
                        .attr("font-size", "11px")
                        .text(function(d) {
                            return d.response;
                        }).each(function() {
                    wrap(d3.select(this), responseWidth - 3);
                })
                        .append("svg:title")
                        .text(function(d) {
                            return d.response;
                        });

                //bar.selectAll

            }

            function wrap(self, width) {
                var textLength = self.node().getComputedTextLength(),
                        text = self.text();
                while (textLength > (width) && text.length > 0) {
                    text = text.slice(0, -1);
                    self.text(text + '...');
                    textLength = self.node().getComputedTextLength();
                }
            }

            //Returns a function to compute the interquartile range.
            function iqr(k) {
                return function(d, i) {
                    var q1 = d.quartiles[0],
                            q3 = d.quartiles[2],
                            iqr = (q3 - q1) * k,
                            i = -1,
                            j = d.length;
                    while (d[++i] < q1 - iqr)
                        ;
                    while (d[--j] > q3 + iqr)
                        ;
                    return [i, j];
                };
            }


        </script>
    </head>
    <body>

        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Responses <input type="checkbox" id="showResponses" checked /></span> 
        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Accuracy stats <input type="checkbox" id="showAccuracyStats" checked /></span>
        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Accuracy graphs <input type="checkbox" id="showAccuracyGraphs" checked /></span>
        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Time stats <input type="checkbox" id="showTimeStats" checked /></span>
        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Time graphs <input type="checkbox" id="showTimeGraphs" checked /></span>
        <span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Task instances <input type="checkbox" id="showTaskInstances" /></span>


        &nbsp&nbsp<span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Use <select id="graphtype">
                <option value="Bar charts" selected>Bar charts</option>
                <option value="Box plots">Box plots</option>
            </select></span>
        
        &nbsp&nbsp<span style='background-color:#F0F0F0; margin:2px 2px 2px 2px'>Aggregate by <select id="conditiontype">
                <option value="Viewer" selected>Viewer</option>
                <option value="Data">Data</option>
                <option value="Viewer and data">Viewer and data</option>
            </select></span>

        <br><br>
        <div id='charts'>
        </div>




    </body>
</html>