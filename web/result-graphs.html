<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Study Results</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="http://d3js.org/d3.v3.min.js"></script>

        <style type="text/css">
            body{
                margin-left: 20px;
                padding-left: 20px;

                margin-bottom: 50px;

            }
            #completionStats{
                margin-left:100px;
            }
            th, td {
                border: 1px solid black;
                text-align: center;
                padding: 5px;   
            }
            #dataSelection{
                width: 500px;
                padding-top: 10px;
                padding-left: 10px;
                margin-left: 200px;
                margin-right: 300px;
            }
            .grayBackground{
                background-color: #E8E8E8 ;
                margin: 1px;
                padding: 1px;
            }
            .hide_borders{
                border: 0px;
                width: 0.2px;
                background-color: gray;
            }
            .hide_borders2{
                border: 0px;
                width: 0.2px;                
            }
            .italics{
                font-style: italic;
            }
            .tableButtons{
                margin-left: 5%;
                margin-right: 5%
            }
            .grayout {
                opacity: 0.2;
                filter: alpha(opacity = 60); //IE
            }
        </style>
        <script type="text/javascript">

            var experimenttype = "";
            var numOfTasks = 0;
            var allAccuracyfilesRows = [];
            var allTimefilesRows = [];

            var tableSelections = [];
            var selectedRowCount = 0;

            window.onload = function() {
                getStudyId();
            };

            //get the studyname and set it.
            function getStudyId() {
                removeDivChildren(document.getElementById("chart"));

                var command = "getStudyId";
                var url = "StudyResults?command=" + command;


                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        if (xmlHttpRequest.responseText !== "") {
                            var split = xmlHttpRequest.responseText.split("::");
                            document.getElementById("studyid").value = xmlHttpRequest.responseText;

                            //get the experimenttype;
                            getExperimentType();
                            getNumberOfTasks();

                            getAnalysisOfResults(); //now get the analysis of the results
                        }
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();

            }
            function getExperimentType() {


                var studyid = document.getElementById("studyid").value;

                var command = "getExperimentType";
                var url = "StudyResults?command=" + command
                        + "&studyid=" + studyid;

                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        if (xmlHttpRequest.responseText !== "") {
                            experimenttype = xmlHttpRequest.responseText;
                        }
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();
            }
            //get and set number of tasks
            function getNumberOfTasks() {
                var studyid = document.getElementById("studyid").value;

                var command = "getNumberOfTasks";
                var url = "StudyResults?command=" + command
                        + "&studyid=" + studyid;

                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        numOfTasks = +xmlHttpRequest.responseText;
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();
            }

            function getAnalysisOfResults() {
                var studyid = document.getElementById("studyid").value;




                getGraphAnalysis(studyid);
                getRAnalysis(studyid);

                getCompletionStats(studyid);

                getCombinedRawDataFilename(studyid, 'summarized');
                // getRawDataFilename(studyid, 'basic');
                loadDataTable("summarized");

            }


            function getCompletionStats(studyid) {
                var command = "getCompletionStats";


                var url = "StudyResults?command=" + command + "&studyid=" + studyid;

                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {

                        if (xmlHttpRequest.responseText !== "") {
                            var theResponse = xmlHttpRequest.responseText;
                            var split = theResponse.split("::");
                            //create a table of the condition and number finished
                            var table = document.createElement("table");
                            var thr = document.createElement("tr");
                            var th1 = document.createElement("th");
                            th1.innerHTML = "Condition-Name";
                            var th2 = document.createElement("th");
                            th2.innerHTML = "Number Finished";

                            thr.appendChild(th1);
                            thr.appendChild(th2);
                            table.appendChild(thr);

                            for (var i = 0; i < split.length; i++) {
                                //create a paragraph with the short name and the number completed.
                                var split2 = split[i].split(",");
                                //create a row for each condition
                                var tr = document.createElement("tr");


                                //create a column for the condition name and a column for the number finished.                               
                                var td1 = document.createElement("td");
                                td1.innerHTML = split2[0];
                                var td2 = document.createElement("td");
                                td2.innerHTML = split2[1];

                                tr.appendChild(td1);
                                tr.appendChild(td2);
                                table.appendChild(tr);
                            }

                            document.getElementById("completionStats").appendChild(table);
                        }
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();

            }


            function getGraphAnalysis(studyid) {
                removeDivChildren(document.getElementById("chart"));
                //get accuracy result
                var command = "getAccuracyAnalysis";
                var url = "StudyResults?command=" + command + "&studyid=" + studyid;

                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        if (xmlHttpRequest.responseText !== "") {
                            drawD3Graphs(xmlHttpRequest.responseText);
                        }
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();


                //get time result
                command = "getTimeAnalysis";
                var url = "StudyResults?command=" + command + "&studyid=" + studyid;

                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        if (xmlHttpRequest.responseText !== "") {
                            //alert(xmlHttpRequest.responseText)
                            drawD3Graphs(xmlHttpRequest.responseText);
                        }
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();

            }

            function drawD3Graphs(result) {
                var valueLabelWidth = 20; // space reserved for value labels (right)
                var barHeight = 15; // height of one bar
                var barLabelWidth = 229; // space reserved for bar labels
                var barLabelPadding = 5; // padding between bar and bar labels (left)
                var gridLabelHeight = 20; // space reserved for gridline labels
                var gridChartOffset = 5; // space between start of grid and first bar
                var maxBarWidth = 200; // width of the bar with the max value

                var maxLabelValue = 0;

                //put in a linebreaker
                var linebreak = document.createElement("br");
                document.getElementById("chart").appendChild(linebreak);


                var split = result.split("::::");

                for (var i = 0; i < split.length; i++) {
                    var taskValues = [];
                    var taskLabels = [];
                    var taskStandardErrorValues = [];

                    var taskdata = split[i].split("::");

                    for (var j = 0; j < taskdata.length; j++) {
                        var cond = taskdata[j].split(",");

                        taskLabels.push(cond[0]);

                        if ((parseFloat(cond[1]) + parseFloat(cond[2])) > maxLabelValue) {
                            maxLabelValue = parseFloat(cond[1]) + parseFloat(cond[2]);
                        }

                        taskValues.push(cond[1]);
                        taskStandardErrorValues.push(cond[2]);
                        //alert(cond[2]);
                    }

                    // alert(taskStandardErrorValues);

                    maxLabelValue = Math.ceil(maxLabelValue);

                    //alert("The MaxLabelValue is " + Math.ceil(maxLabelValue));
                    /**  draw the graph with the d3 values */
                    var yScale = d3.scale.ordinal().domain(d3.range(0, taskValues.length)).rangeBands([0, taskValues.length * barHeight + 5]);

                    var y = function(d, i) {
                        return yScale(i) * 2 + 2;
                    };
                    var yText = function(d, i) {
                        return y(d, i) + yScale.rangeBand() / 2;
                    };

                    var barValue = function(d) {
                        return parseFloat(d);
                    };


                    var x = d3.scale.linear().domain([0, maxLabelValue]).rangeRound([0, maxBarWidth]); //Use rangeRound() in place of range() and all values output by the scale will be rounded to the nearest whole number. This is useful if you want shapes to have exact pixel values, to avoid the fuzzy edges that may arise with antialiasing.

                    // svg container
                    /*  var chartid = "chart" + (i + 1);
                     
                     var div = document.createElement("div");
                     div.setAttribute("id", chartid);
                     var d3GraphDiv = document.getElementById("d3Graphs");
                     d3GraphDiv.appendChild(div);*/



                    var chart = d3.select('#chart').append("svg")
                            .attr('width', maxBarWidth + barLabelWidth + valueLabelWidth)
                            .attr('height', gridLabelHeight + gridChartOffset + taskValues.length * barHeight * 6);

                    //bar labels
                    var barLabel = function(d) {
                        return d;
                    };

                    var labelsContainer = chart.append('g')
                            .attr('transform', 'translate(' + (barLabelWidth - barLabelPadding) + ',' + (gridLabelHeight + gridChartOffset) + ')');

                    labelsContainer.selectAll('text').data(taskLabels).enter().append('text')
                            .attr('y', yText)
                            .attr('stroke', 'none')
                            .attr('fill', 'black')
                            .attr("dy", ".35em") // vertical-align: middle
                            .attr('text-anchor', 'end')
                            .text(barLabel)
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "12px");


                    //bars
                    var barsContainer = chart.append('g')
                            .attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');


                    barsContainer.selectAll("rect").data(taskValues).enter().append("rect")
                            .attr('y', function(d, i) {
                                return yScale(i) * 2 + 0 * barHeight;
                            })
                            .attr('height', yScale.rangeBand())
                            .attr('width', function(d) {
                                return x(barValue(d));
                            })
                            .attr('fill', '#787878').attr('stroke', 'none')
                            .attr('color', "blue")
                            .text(function(d) {
                                //alert(d);
                                return d;
                            });



                    // grid line labels
                    var gridContainer = chart.append('g')
                            .attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')');

                    gridContainer.selectAll("text").data(x.ticks(5)).enter().append("text")
                            .attr("x", x)
                            .attr("dy", 0)
                            .attr("text-anchor", "middle")
                            .text(String)
                            .attr("font-family", "sans-serif")
                            .attr("font-size", "15px");

                    // vertical grid lines
                    chart.selectAll("line").data(x.ticks(5)).enter().append("line").attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')')
                            .attr("x1", x)
                            .attr("x2", x)
                            .attr("y1", 2)
                            .attr("y2", 5)
                            .style("stroke", "black")
                            .style("stroke-width", "2px");

                    gridContainer.selectAll("line").data(x.ticks(5)).enter().append("line")
                            .attr("x1", x)
                            .attr("x2", x)
                            .attr("y1", 14)
                            .attr("y2", (yScale.rangeExtent()[1] + gridChartOffset) * 5)
                            .style("stroke", "white")
                            .style("stroke-width", "0");

                    // start line
                    barsContainer.append("line")
                            .attr("y1", 0)
                            .attr("y2", (yScale.rangeExtent()[1] + gridChartOffset) * taskValues.length)
                            .style("stroke", "black")
                            .style("stroke-width", 1);






                    //draw the error bars
                    var errorBars = chart.append('g')
                            .attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');

                    //chart.selectAll("line").data(x.ticks(5)).enter().append("line").attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')')
                    errorBars.selectAll("line").data(taskValues).enter().append("line")
                            .attr("x1", function(d, i) {
                                return x(barValue(d)) - x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("x2", function(d, i) {
                                return x(barValue(d)) + x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("y1", function(d, i) {
                                return (yScale(i) * 2 + 0 * barHeight)
                                        + (yScale.rangeBand() / 2);
                            })
                            .attr("y2", function(d, i) {
                                //function(d, i) {
                                return (yScale(i) * 2 + 0 * barHeight)
                                        + (yScale.rangeBand() / 2);
                            })

                            .style("stroke-width", 2)
                            .style("stroke", "blue");


                    //small lines for error lines
                    var errorBar_vertical1 = chart.append('g')
                            .attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');

                    //chart.selectAll("line").data(x.ticks(5)).enter().append("line").attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')')
                    errorBar_vertical1.selectAll("line").data(taskValues).enter().append("line")
                            .attr("x1", function(d, i) {
                                return x(barValue(d)) - x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("x2", function(d, i) {
                                return x(barValue(d)) - x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("y1", function(d, i) {
                                return (yScale(i) * 2 + 0 * barHeight) + 5
                                        ;
                            })
                            .attr("y2", function(d, i) {
                                //function(d, i) {
                                return (yScale(i) * 2 + 0 * barHeight)
                                        + (yScale.rangeBand()) - 5;
                            })
                            .style("stroke-width", 2)
                            .style("stroke", "blue");


                    //small lines for error lines
                    var errorBar_vertical2 = chart.append('g')
                            .attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');

                    //chart.selectAll("line").data(x.ticks(5)).enter().append("line").attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')')
                    errorBar_vertical2.selectAll("line").data(taskValues).enter().append("line")
                            .attr("x1", function(d, i) {
                                return x(barValue(d)) + x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("x2", function(d, i) {
                                //alert("x2 is ")
                                return x(barValue(d)) + x(barValue(taskStandardErrorValues[i]));
                            })
                            .attr("y1", function(d, i) {

                                //  alert("y1 is "+ ((yScale(i) * 2 + 0 * barHeight) + 5));
                                return (yScale(i) * 2 + 0 * barHeight) + 5;
                            })
                            .attr("y2", function(d, i) {
                                //  alert("y2 is " + ((yScale(i) * 2 + 0 * barHeight)+ (yScale.rangeBand()) - 5));
                                return (yScale(i) * 2 + 0 * barHeight) + (yScale.rangeBand()) - 5;
                            })
                            .style("stroke-width", 1)
                            .style("stroke", "black");


                }

                //Now draw d3 with the values
            }



            function getRAnalysis(studyid) {
                var command = "getRAnalysis";
                //get the analysis types that the user wants
                /*var typesList = "";
                 var list = document.form1.analysis;
                 for (var i = 0; i < list.length; i++) {
                 if (list[i].checked) {
                 typesList += list[i].value + ", ";
                 }
                 }*/



                var url = "StudyResults?command=" + command + "&studyid=" + studyid;

                //make a request to the servlet, get the analsyis and then display them
                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {



                        //put that result as in the analysis div location
                        var analysisDiv = document.getElementById("analysis");
                        removeDivChildren(analysisDiv);

                        var outputFilenames = (xmlHttpRequest.responseText).split("::");
                        //  alert(outputFilenames);

                        for (var i = 0; i < outputFilenames.length; i++) {
                            var anchor = document.createElement("a");
                            var url = "" + outputFilenames[i];
                            anchor.setAttribute("href", url);
                            anchor.innerHTML = outputFilenames[i].substring(outputFilenames[i].lastIndexOf("/") + 1);

                            analysisDiv.appendChild(anchor);

                            analysisDiv.appendChild(document.createElement("br"));
                            analysisDiv.appendChild(document.createElement("br"));

                        }


                    }
                };

                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();
            }

            function getCombinedRawDataFilename(studyid, type) {
                //send a request to the servlet, you will receive the name of the file at the end
                var command = "getCombinedRawDataFileName";
                //  var userid = document.getElementById("userid").value;

                var url = "StudyResults?command=" + command + "&type=" + type
                        + "&studyid=" + studyid;

                //make a request to the servlet, get the name of the file and create a link for it
                var xmlHttpRequest = getXMLHttpRequest();

                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        //alert(xmlHttpRequest.responseText);
                        //put that result as in the rawData div location
                        var rawDataDiv = document.getElementById("rawDataFilenames");
                        //removeDivChildren(rawDataDiv);

                        var outputFilename = xmlHttpRequest.responseText;

                        var anchor = document.createElement("a");

                        var url = outputFilename;

                        //alert(outputFilename);

                        anchor.setAttribute("href", url);
                        anchor.innerHTML = type + " raw data";


                        rawDataDiv.appendChild(document.createElement("br"));

                        rawDataDiv.appendChild(anchor);

                        rawDataDiv.appendChild(document.createElement("br"));
                        rawDataDiv.appendChild(document.createElement("br"));

                    }
                };

                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();
            }



            function getXMLHttpRequest() {
                var xmlHttpReq;
                // to create XMLHttpRequest object in non-Microsoft browsers  
                if (window.XMLHttpRequest) {
                    xmlHttpReq = new XMLHttpRequest();
                } else if (window.ActiveXObject) {
                    try {
                        //to create XMLHttpRequest object in later versions of Internet Explorer  
                        xmlHttpReq = new ActiveXObject("Msxml2.XMLHTTP");
                    } catch (exp1) {
                        try {
                            //to create XMLHttpRequest object in later versions of Internet Explorer  
                            xmlHttpReq = new ActiveXObject("Microsoft.XMLHTTP");
                        } catch (exp2) {
                            //xmlHttpReq = false;  
                            alert("Exception in getXMLHttpRequest()!");
                        }
                    }
                }
                return xmlHttpReq;
            }

            //this function removes the div's children
            function removeDivChildren(div) {
                var last;
                while (last = div.lastChild)
                    div.removeChild(last);
            }

            function dataTypeChanged() {
                alert("data has been changed");
            }

            //this function will load a specific data type and create a table for that data
            function loadDataTable(datatype) {
                var studyid = document.getElementById("studyid").value;

                //send a request to the servlet, you will receive the name of the file at the end
                var command = "getAllRawDataFilenames";

                var url = "StudyResults?command=" + command + "&type=" + datatype
                        + "&studyid=" + studyid;
                //make a request to the servlet, get the name of the file and create a link for it
                var xmlHttpRequest = getXMLHttpRequest();
                xmlHttpRequest.onreadystatechange = function()
                {
                    if (xmlHttpRequest.readyState === 4 && xmlHttpRequest.status === 200)
                    {
                        removeDivChildren(document.getElementById("dataTableDiv"));
                        var filename = xmlHttpRequest.responseText;

                        // alert(xmlHttpRequest.responseText);

                        var conditions = xmlHttpRequest.responseText.split("::::");
                        var conditionAccuracy = [];
                        var conditionTime = [];

                        for (var i = 0; i < conditions.length; i++) {

                            var condition = conditions[i].split("::");

                            conditionAccuracy.push(condition[0]);
                            conditionTime.push(condition[1]);
                        }


                        //create a table with the condition names


                        //create a table here.
                        var table = document.createElement("table");

                        table.setAttribute("id", "curDataTable");
                        //header row.
                        var thr = document.createElement("tr");
                        thr.setAttribute("id", "data_headerRow");




                        filename = conditionAccuracy[0];


                        for (var i = 0; i < conditionAccuracy.length; i++) {

                            //accuracy
                            filename = conditionAccuracy[i];
                            d3.csv(filename, function(rows) {
                                allAccuracyfilesRows.push(rows);
                            });

                            //time
                            filename = conditionTime[i];
                            //  alert(filename);
                            d3.csv(filename, function(rows) {
                                //alert(rows);
                                allTimefilesRows.push(rows);
                            });
                        }




                        setTimeout(function() {
                            //populate the table
                            var thr0 = document.createElement("tr");
                            var cnt1 = 0;
                            for (var i = 0; i < allAccuracyfilesRows.length; i++) {

                                var rows = allAccuracyfilesRows[i];
                                //first lets get the row                             

                                var keys = d3.keys(rows[i]);

                                //  for (var k = 0; k < keys.length; k++) {
                                var split = keys[0].split("_");

                                var cond_name = split[split.length - 1];


                                var th0 = document.createElement("th");
                                th0.setAttribute("colspan", "" + numOfTasks * 2);
                                th0.innerHTML = cond_name;


                                var cell_before = document.createElement("th");

                                if (cnt1 === 0) {
                                    cell_before.setAttribute("class", "hide_borders2");
                                }
                                else {
                                    cell_before.setAttribute("class", "hide_borders");
                                }

                                thr0.appendChild(cell_before);

                                thr0.appendChild(th0);
                                // }

                                cnt1++;
                            }
                            table.appendChild(thr0);

                            //create the task headers
                            for (var i = 0; i < allAccuracyfilesRows.length; i++) {
                                var rows = allAccuracyfilesRows[i];


                                var th = document.createElement("th");

                                if (i === 0) {
                                    th.setAttribute("class", "hide_borders2");
                                }
                                else {
                                    th.setAttribute("class", "hide_borders");
                                }
                                thr.appendChild(th);

                                for (var j = 0; j < keys.length; j++) {
                                    var header = document.createElement("th");
                                    var split = keys[j].split("_");
                                    var cond_indx = split.length;
                                    var firstIndex = keys[j].indexOf("_");
                                    var lastIndex = keys[j].lastIndexOf("_");
                                    var taskname = keys[j].substring(firstIndex + 1, lastIndex);



                                    header.innerHTML = taskname;
                                    header.setAttribute("colspan", "2");
                                    thr.appendChild(header);
                                }
                                table.appendChild(thr);
                            }

                            //create the accuracy and time headers.
                            var thr2 = document.createElement("tr");

                            for (var i = 0; i < allAccuracyfilesRows.length; i++) {
                                var cnt_acc_time = 0;

                                var th2 = document.createElement("td");
                                if (i === 0) {
                                    th2.setAttribute("class", "hide_borders2");
                                }
                                else {
                                    th2.setAttribute("class", "hide_borders");
                                }
                                thr2.appendChild(th2);

                                for (var j = 0; j < keys.length; j++) {

                                    var acc_head = document.createElement("td");
                                    acc_head.setAttribute("class", "italics");
                                    acc_head.innerHTML = "Acc";

                                    thr2.appendChild(acc_head);

                                    var time_head = document.createElement("td");
                                    time_head.innerHTML = "Time";
                                    time_head.setAttribute("class", "italics");
                                    thr2.appendChild(time_head);
                                }
                                table.appendChild(thr2);

                            }



                            var tableNumber = 0;
                            var maxRowNumber = 0;
                            //just get the accuracy data for now.
                            for (var i = 0; i < allAccuracyfilesRows.length; i++) {

                                var rows = allAccuracyfilesRows[i];

                                if (rows.length > maxRowNumber) {
                                    maxRowNumber = rows.length;
                                }
                            }

                            for (var i = 0; i < maxRowNumber; i++) {
                                var tr = document.createElement("tr");
                                tr.setAttribute("id", "row_" + tableNumber + "_" + i);
                                var cnt2 = 0;

                                for (var j = 0; j < allAccuracyfilesRows.length; j++) {
                                    var rows = allAccuracyfilesRows[j];
                                    var time_rows = allTimefilesRows[j];
                                    var keys = d3.keys(rows[0]);
                                    var time_keys = d3.keys(time_rows[0]);

                                    var row = rows[i];
                                    var time_row = time_rows[i];

                                    if (cnt2 === 0) {
                                        var td1 = document.createElement("td");
                                        var chbx = document.createElement("input");
                                        chbx.setAttribute("type", "checkbox");
                                        chbx.setAttribute("id", "chkbx_" + tableNumber + "_" + i);//row-number part of the id, which we will get later
                                        chbx.setAttribute("onclick", "dataRowSelected(this);");

                                        td1.appendChild(chbx);
                                        tr.appendChild(td1);
                                    }
                                    else {
                                        var td1 = document.createElement("td");
                                        td1.setAttribute("class", "hide_borders");
                                        td1.innerHTML = "";  //leave some column between conditions
                                        tr.appendChild(td1);
                                    }

                                    for (var k = 0; k < keys.length; k++) {
                                        //create a column for the accuracy of this value
                                        var td = document.createElement("td");

                                        var val = "";
                                        //if there is a row get the value otherwise
                                        //we will put a an empty space there.
                                        if (row) {
                                            val = row[keys[k]];
                                        }
                                        td.innerHTML = val;
                                        //  alert(td.innerHTML);
                                        tr.appendChild(td);

                                        //do something similar for time
                                        //create a column for the accuracy of this value
                                        var td_t = document.createElement("td");

                                        var val_t = "";
                                        //if there is a row get the value otherwise
                                        //we will put a an empty space there.
                                        if (time_row) {
                                            val_t = time_row[time_keys[k]];
                                        }
                                        td_t.innerHTML = val_t;
                                        //  alert(td.innerHTML);
                                        tr.appendChild(td_t);

                                    }
                                    cnt2++;

                                }
                                //alert("adding to table now");
                                table.appendChild(tr);
                            }


                            //add the table just created to the dataTableDiv.
                            var dataTableDiv = document.getElementById("dataTableDiv");
                            dataTableDiv.appendChild(table);
                        }, 1500);
                    }
                };
                xmlHttpRequest.open("GET", url, false);
                xmlHttpRequest.send();
            }

            function dataRowSelected(element) {

                var split = element.id.split("_");

                var tableNumber = +split[1];
                var rowNumber = +split[2];

                //if it is checked, we will be adding it to the 
                if (element.checked === true) {
                    //add it to the selections in that table.
                    selectedRowCount++;
                    if (tableSelections[tableNumber]) {
                        tableSelections[tableNumber].push(rowNumber);
                    }
                    else {
                        tableSelections[tableNumber] = [];
                        tableSelections[tableNumber].push(rowNumber);
                    }
                }
                else {
                    //remove the row from the selected table.
                    selectedRowCount--;
                    var selections = tableSelections[tableNumber];
                    var index = -1;
                    for (var i = 0; i < selections.length; i++) {
                        if (rowNumber === selections[i]) {
                            index = i;
                            break;
                        }
                    }


                    //now remove this index from the array.
                    tableSelections[tableNumber].splice(index, 1);
                    //alert(tableSelections[tableNumber]);
                }

                //enable the table buttons
                if (selectedRowCount > 0) {
                    document.getElementById("filterRows_button").disabled = false;
                    document.getElementById("deleteRows_button").disabled = false;


                }
                else {
                    //disable the table buttons
                    document.getElementById("filterRows_button").disabled = true;
                    document.getElementById("deleteRows_button").disabled = true;
                }

            }


            function filterSelectedRows(element) {
                var elem_parent = element.parentNode;

                var tableNumber = elem_parent.id.split("_")[1];
                tableNumber = +tableNumber;

                var selections = tableSelections[tableNumber];

                for (var i = 0; i < selections.length; i++) {
                    var id = "#row_" + tableNumber + "_" + selections[i];

                    d3.select(id).classed("grayout", true);
                }

            }

            function deleteSelectedRows(element) {

                var r = confirm("Are you sure you want to delete these rows permanently?");
                if (r === true) {
                    alert("Okay! It will be deleted soon.");
                }

            }

        </script>

    </head>
    <body>
        <div style="margin-left:200px; margin-top: 5px;">
            <h4><em>(Please refresh the page if you do not see barcharts)</em></h4>            
        </div>        
        <div id="completionStats" style="margin-left:200px;">
            <h4>Number of completed studies (per experimental condition)</h4> 
        </div>
        <br/><br/>
        <div id="dataSelection" class="grayBackground">
            Select a data to show 
            <select onchange="dataTypeChanged();">
                <option selected>Summarized Study Tasks Results</option>
                <option>Raw Study Tasks Results</option>
                <option>Results of Study Tasks without correct Answers</option>
                <option>Pre-Study Results</option>
                <option>Post-Study results</option>

            </select> 
            <br/><br/>
        </div>


        <div> 
            <h4>Graphs of the Results</h4> <hr />
            <div id="chart"></div>
            <h4>Statistical Analysis of Results (R)</h4> <hr />
            <div id="analysis"></div>
            <h4>Raw Results Files </h4> <hr />
            <div id="rawDataFilenames"></div>

            <br/>
            <div id="tableButtons_0" class="tableButtons">
                <input type="button" value="Filter Selected Rows"  id="filterRows_button" disabled
                       onclick="filterSelectedRows(this);"/>
                <input type="button" value="Delete Selected rows" id="deleteRows_button" disabled
                       onclick="deleteSelectedRows(this);"/>
            </div>
            <br/><br/>
            <div id="dataTableDiv">

            </div>

            <br/>
            <hr/>

            <input type="hidden" id="studyid" name="studyid" value="" />


        </div>

    </body>
</html>
