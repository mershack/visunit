<!DOCTYPE html>
<html>
    <head>

        <style>

            .smalltext{
                font-size: 12px;
            }
            .smallesttext{
                font-size: 10px;
            }            
            .inputrow{
                background-color : rgba(255,255,255,0.3)
            }
            .help{
                color : darkgreen;
                font-size: 13px;
                padding : 1px 3px 1px 3px;
            }

            .inputlabel{
                font-size: 14px;
                margin: 0px 0px -4px 0px
            }
            .fieldlabel{
                font-size: 14px;
                font-weight: bold;
            }

            .questionmark{
                font-size: 13px;
                background-color: rgba(150,250,150,0.3);
                padding: 0px 5px 0px 5px;
            }
            .questionmarkover{
                background-color: rgba(150,250,150,0.5);
            }

            table, th, td {
                border: 0px solid black;
                border-collapse: collapse;
            }
            td{

                background-color: rgba(100,100,100,0);
                vertical-align:top;
                padding-right:10px;
            }

            .hometile{
                border-style: solid;
                border-color: lightgray;
                border-width: 3px;
                border-radius: 10px;
                padding: 5px 5px 5px 5px;
                margin: 5px 2px 5px 2px;
                display : inline-block;
            }
            .hometilehov{
                border-color: black;
            }

            .studytile {
                background-color: rgb(220,245,255);
            }
            .viewertile {
                background-color: rgb(220,245,255);
            }
            .datasettile {
                background-color: rgb(220,245,255);
            }
            .taskprototile {
                background-color: rgb(220,245,255);
            }	
            .taskinstancetile {
                background-color: rgb(220,245,255);
            }

            .resultstile {
                background-color: rgb(220,245,255);
            }
            .introtile{
                background-color : rgb(220,245,255);
            }
            .testtile{
                background-color: rgb(220,245,255);
            }
            
            .ingredientHeader{
                color:rgb(220,245,255); 
                font-weight: bold; 
                letter-spacing: 2px; 
                text-transform: uppercase; 
                margin-bottom:-2px;
                margin-top: 10px;
            }


            #homedivheader{
                font-size:26px;
                background-color: steelblue;
                padding: 5px 5px 5px 5px;
                margin: 0px 0px 0px 0px;
            }

            #homediv{
                background-color: steelblue;
                padding: 10px 5px 10px 5px;
                margin: 0px 0px 0px 0px;
            }

            #studyform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #viewerform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #datasetform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }


            #taskprotoform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #taskinstanceform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #resultsform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #introform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            #testform{
                background-color: rgb(220,245,255);
                margin-top: 10px;
                padding: 5px 5px 5px 5px;
            }

            .inputdiv{
                background-color: rgba(100,100,100,0.2);
                padding: 3px 3px 3px 3px;
                margin: 5px 5px 5px 20px;
                display: inline-block;
            }



            .dataset {
                background-color: green;
            }

            .taskproto {
                background-color: yellow;
            }

            .taskinst {
                background-color: gray;
            }

            .button {
                background-color: #DDFFDD;
                border-radius: 5px;
                padding: 1px 3px 0px 3px;
                border-width: 2px;
                border-style: solid;
                display : inline-block;

                border-color: lightgreen;
                margin: 5px 1px 5px 1px;
            }
            .buttonover{
                background-color: #AAEEAA;
                border-color: green;
            }
            .buttonclick{
                background-color: #CCEEAA;
                border-color: yellow;
            }
            .buttoninactive{
                background-color: #DDDFDD;
                border-color: gray;
            }
            #taskInstanceViewerFrame{
                display: block;
                border: 2px solid black;
                margin: 0px;
                padding: 0px;
                height: 750px;
                width: 100%;
                background: white;
            }
            #taskInstanceViewerFrameDiv{
                float: left;
                height: 800px;
                width: 68%;
            }

            #propControl{
                float: right;
                width: 28%;
                height: 730px;
                border: solid #000;
                padding: 10px;   
                margin-right: 10px;
                background: white;
            }

            #taskinstanceform_taskcreator{
                min-width: 925px;
                height: 800px;
                background-color:lightgray;
            }









        </style>

        <script src="jquery.min.js"></script>
        <script src="servercomm.js"></script>
        <script src="fileManager.js"></script>
        <script src="utils.js"></script>
        <script src="taskinstances.js"></script>
        <script src="answers.js"></script>
        <script src="latin_square.js"></script>
        <script>

            var currentStudy = null; //current study being edited
            var currentViewer = null;
            var currentDataset = null;
            var currentTaskproto = null;
            var currrentTaskinstance = null;
            var currentIntro = null;
            var currentTest = null;
            
            var fileManager = null;

            var studies = [];
            var viewers = [];
            var datasets = [];
            var taskprotos = [];
            var taskinstances = [];
            var intros = [];
            var tests = [];
            var directories = [];


            var uniqueViewerId = 0;
            var uniqueTaskId = 0;
            var uniqueDatasetId = 0;
            var uniqueIntroId = 0;
            var uniqueTestId = 0;
            var uniqueInputId = 0;
            var uniqueAnswerOptionId = 0;
            var uniqueEntrytaskId = 0;
            var uniqueExittaskId = 0;

            $(document).ready(function() {

                loadAllData(function() {


                    $("#studyform").hide();
                    $("#viewerform").hide();
                    $("#datasetform").hide();
                    $("#taskprotoform").hide();
                    $("#taskinstanceform").hide();
                    $("#resultsform").hide();
                    $("#introform").hide();
                    $("#testform").hide();

                    checkAllStudyCompletness();


                    addHometileHandlers();

                    $(".help").hide();
                    $(".questionmark").mouseenter(function() {
                        $(this).addClass("questionmarkover");
                        var id = $(this).attr("id");
                        $("#" + id + "_").show();
                    });
                    $(".questionmark").mouseleave(function() {
                        $(this).removeClass("questionmarkover");
                        var id = $(this).attr("id");
                        $("#" + id + "_").hide();
                    });


                    $("#studydiv").hide();

                    addButtonHandlers();

                    addFormHandlers("viewerform");
                    addFormHandlers("introform");
                    addFormHandlers("testform");

                });



            });


            function addHometileHandlers() {
                $(".hometile").mouseenter(function() {
                    $(this).addClass("hometilehov");
                });
                $(".hometile").mouseleave(function() {
                    $(this).removeClass("hometilehov");
                });

                $(".hometile").click(function() {
                    var study = $(this)[0].data;
                    var tileType = $(this)[0].tileType;
                    $("#homediv").slideUp(200, function() {
                        $("#homedivheader").animate({opacity: '0.5'}, 300, function() {
                            $("#homedivheader").animate({opacity: '1'}, 300, function() {
                                if (tileType === "study") {
                                    $("#studyform").show(300);
                                }
                                else if (tileType === "viewer")
                                    $("#viewerform").show(300);
                                else if (tileType === "dataset")
                                    $("#datasetform").show(300);
                                else if (tileType === "taskproto")
                                    $("#taskprotoform").show(300);
                                else if (tileType === "taskinstance")
                                    $("#taskinstanceform").show(300);
                                else if (tileType === "intro")
                                    $("#introform").show(300);
                                else if (tileType === "test")
                                    $("#testform").show(300);
                            })
                        })

                    });


                    if (tileType === "study") {
                        putStudyDataInForm(study);
                        currentStudy = $(this)[0];
                    }
                    else if (tileType === "viewer") {
                        putDataInForm("viewerform", study);
                        currentViewer = $(this)[0];
                    }
                    else if (tileType === "dataset") {
                        putDataInForm("datasetform", study);
                        currentDataset = $(this)[0];
                    }
                    else if (tileType === "taskproto") {
                        putTaskprotoDataInForm(study);
                        currentTaskproto = $(this)[0];
                    }
                    else if (tileType === "taskinstance") {
                        putTaskinstanceDataInForm(study);
                        currentTaskinstance = $(this)[0];
                    }
                    else if (tileType === "intro") {
                        putDataInForm("introform", study);
                        currentIntro = $(this)[0];
                    }
                    else if (tileType === "test") {
                        putDataInForm("testform", study);
                        currentTest = $(this)[0];
                    }

                });
            }
            function addButtonHandlers() {
                $(".button").mouseenter(function() {
                    if (!$(this).hasClass("buttoninactive"))
                        $(this).addClass("buttonover");
                });
                $(".button").mouseleave(function() {
                    $(this).removeClass("buttonover");
                });

                $(".button").click(function(evt) {
                    if (!$(this).hasClass("buttoninactive")) {
                        $(this).addClass("buttonclick");
                        $(this).animate({opacity: '1'}, 100, function() {
                            $(this).removeClass("buttonclick");
                            processButtonClick($(this).attr("id"));
                        });
                    }
                    evt.stopImmediatePropagation();
                });
            }


            function processButtonClick(which) {
                split = which.split("_||_");

                if (split[0] === "home") //a button in the main, home, panel was clicked
                    homeAction(split);
                else if (split[0] === "studyform") //a button in the studyform was clicked
                    studyFormAction(split);
                else if (split[0] === "viewerform") //a button in the studyform was clicked
                    formAction(split);
                else if (split[0] === "datasetform") //a button in the studyform was clicked
                    formAction(split);
                else if (split[0] === "taskprotoform") //a button in the studyform was clicked
                    taskprotoFormAction(split);
                else if (split[0] === "taskinstanceform") //a button in the studyform was clicked
                    taskinstanceFormAction(split);
                else if (split[0] === "resultform") //a button in the studyform was clicked
                    resultFormAction(split);
                else if (split[0] === "introform")
                    formAction(split);
                else if (split[0] === "testform")
                    formAction(split);
                else if (split[0] === "adddirform")
                    formAction(split);
            }

            function homeAction(split) {
                if (split[1] === "delstudy"){
                    removeStudy(split[2]);
                }
                else if (split[1] === "copystudy")
                    copyStudy(split[2]);
                else if (split[1] === "addstudy")
                    addNewStudy();
                else if (split[1] === "studyresults") {
                    studyResults(split[2]);
                }
                else if (split[1] === "addviewer")
                    addNewViewer();
                else if (split[1] === "adddataset")
                    addNewDataset();
                else if (split[1] === "addtaskproto")
                    addNewTaskproto();
                else if (split[1] === "addtaskinstance")
                    addNewTaskinstance();
                else if (split[1] === "addintro")
                    addNewIntro();
                else if (split[1] === "addtest")
                    addNewTest();
            }

            //Loads all data associated with the user's account. This includes
            //studies, datasets, viewers, etc. Call the whendone callback function at the end.
            function loadAllData(whendone) {

               
                fileManagerCreate($("#adddirform"), function(success, msg, fm) {
                    if (success) {
                        fileManager = fm;                        
                        loadStudies(function(success, msg, _studies) {
                            if (success) {
                                for (var i = 0; i < _studies.length; i++) {
                                    var icon = createStudyIcon(_studies[i]);
                                    $("#homediv_studysection").append(icon);
                                    studies.push(icon);
                                }
                                loadViewers(function(success, msg, _viewers) {
                                    if (success) {
                                        //viewers are loaded
                                        for (var i = 0; i < _viewers.length; i++) {
                                            var icon = createViewerIcon(_viewers[i]);
                                            $("#homediv_viewersection").append(icon);
                                            viewers.push(icon);
                                        }
                                        loadDatasets(function(success, msg, _datasets) {
                                            if (success) {
                                                for (var i = 0; i < _datasets.length; i++) {
                                                    var icon = createDatasetIcon(_datasets[i]);
                                                    $("#homediv_datasetsection").append(icon);
                                                    datasets.push(icon);
                                                }
                                                loadTaskprotos(function(success, msg, _taskprotos) {
                                                    if (success) {
                                                        for (var i = 0; i < _taskprotos.length; i++) {
                                                            var icon = createTaskprotoIcon(_taskprotos[i]);
                                                            $("#homediv_taskprotosection").append(icon);
                                                            taskprotos.push(icon);
                                                        }
                                                        loadTaskinstances(function(success, msg, _taskinstances) {
                                                            if (success) {
                                                                for (var i = 0; i < _taskinstances.length; i++) {                                                                    
                                                                    var icon = createTaskinstanceIcon(_taskinstances[i]);
                                                                    $("#homediv_taskinstancesection").append(icon);
                                                                    taskinstances.push(icon);
                                                                }
                                                                loadIntros(function(success, msg, _intros) {
                                                                    if (success) {
                                                                        for (var i = 0; i < _intros.length; i++) {
                                                                            var icon = createIntroIcon(_intros[i]);
                                                                            $("#homediv_introsection").append(icon);
                                                                            intros.push(icon);
                                                                        }
                                                                        loadTests(function(success, msg, _tests) {
                                                                            if (success) {
                                                                                for (var i = 0; i < _tests.length; i++) {
                                                                                    var icon = createTestIcon(_tests[i]);
                                                                                    $("#homediv_testsection").append(icon);
                                                                                    tests.push(icon);
                                                                                }
                                                                                whendone(true, "");
                                                                            }
                                                                            else
                                                                                whendone(false, msg);
                                                                        });
                                                                    }
                                                                    else
                                                                        whendone(false, msg);
                                                                });
                                                            }
                                                            else
                                                                whendone(false, msg);
                                                        });
                                                    }
                                                    else
                                                        whendone(false, msg);
                                                });
                                            }
                                            else
                                                whendone(false, msg);
                                        });
                                    }
                                    else
                                        whendone(false, msg);
                                });
                            }
                            else
                                whendone(false, msg);
                        });
                    }
                    else
                        whendone(false, msg);
                });
            }




            function createStudyIcon(studydata) {

                var studyicon = document.createElement("div");
                studyicon.data = studydata;
                studyicon.tileType = "study";
                studyicon.id = "studyicon_" + studydata.name;

                studyicon.innerHTML = createStudyIconContent(studydata);
                studyicon.className = "hometile studytile";

                return studyicon;
            }

            function updateStudyIcon(icon, studydata) {
                icon.innerHTML = createStudyIconContent(studydata);
                icon.id = "studyicon_" + studydata.name;
                addButtonHandlers();
            }

            function createStudyIconContent(studydata) {

                var html = "<span class='incomplete' " + (isStudyComplete(studydata) === null ? "style='display:none '" : "");
                html += "title='Your study and/or some of its ingredients are incompletely defined'>";
                
                html += "<img src='exclamation-icon.png' width=14 height=14></img>" + 
                        "</span>&nbsp" + studydata.name + "<br><span style='font-size:12px'> Viewers:";
                
          
                for (var i = 0; i < studydata.viewers.length; i++) {
                    html += studydata.viewers[i];
                    if (i != studydata.viewers.length - 1)
                        html += ", ";
                }
                html += "</span>";

                html += "<br>";

                html += "<span style='font-size:12px'>Results:&nbsp" + (studydata.resultsCount == 0 ? "none yet" : studydata.resultsCount) + "</span>";
                //create buttons
                html += "<div style='text-align:right'>";
                 html += "<span class=button id=home_||_delstudy_||_" + studydata.name + ">"
                        + "<img src='x-icon.png' height=12 width=12>"
                        + "</a></span>";
                html += "<span class=button id=home_||_copystudy_||_" + studydata.name + " title='Duplicate this study. Results are not copied and the new copy is editable'><img src='duplicate-icon.png' height=12 width=12></span>";
                
                if (studydata.resultsCount == 0) {
                    html += "<span class='button buttoninactive' title='View study results (there are none yet)'" + "id=home_||_studyresults_||_" + studydata.name + "><img src='results-icon.png' height=12 width=12></span></div>";
                }
                else {
                    html += "<span class='button' title='View study results("+studydata.resultsCount +")' id=home_||_studyresults_||_"+ studydata.name+"><img src='results-icon.png' height=12 width=12></span></div>";
                }


                return html;
            }

            function removeStudy(which) {
                
                var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeStudyFile(which, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success){                        
                            $("#studyicon_" +which).remove();
                         }
                    });
                }
            }

            function studyResults(which) {               
                window.location = "Results.html?studyName="+which;
                    
            }

            function copyStudy(which) {

                for (var i = 0; i < studies.length; i++)
                    if (studies[i].data.name === which) {                   

                        //copy all the data, alter the name
                        var newstudy = new Object();
                        newstudy.name = studies[i].data.name + "_copy" + new Date().getTime();
                        newstudy.viewers = [];
                        for (var j = 0; j < studies[i].data.viewers.length; j++)
                            newstudy.viewers.push(studies[i].data.viewers[j]);
                        newstudy.viewerDesign = studies[i].data.viewerDesign;
                        newstudy.datasets = [];
                        for (var j = 0; j < studies[i].data.datasets.length; j++)
                            newstudy.datasets.push(studies[i].data.datasets[j]);
                        newstudy.dataDesign = studies[i].data.dataDesign;
                        newstudy.tasks = [];
                        for (var j = 0; j < studies[i].data.tasks.length; j++) {
                            var oldobj = studies[i].data.tasks[j];
                            var newobj = {name: oldobj.name, count: oldobj.count, time: oldobj.time, training: oldobj.training};
                            newstudy.tasks.push(newobj);
                        }
                        newstudy.taskDesign = studies[i].data.taskDesign;
                        newstudy.entryTasks = [];
                        for (var j = 0; j < studies[i].data.entryTasks.length; j++)
                            newstudy.entryTasks.push(studies[i].data.entryTasks[j]);
                        newstudy.exitTasks = [];
                        for (var j = 0; j < studies[i].data.exitTasks.length; j++)
                            newstudy.exitTasks.push(studies[i].data.exitTasks[j]);
                        newstudy.intros = [];
                        for (var j = 0; j < studies[i].data.intros.length; j++) {
                            var newobj = {name: studies[i].data.intros[j].name, match: studies[i].data.intros[j].match};
                            newstudy.intros.push(newobj);
                        }
                        newstudy.tests = [];
                        for (var j = 0; j < studies[i].data.tests.length; j++) {
                            var newobj = {name: studies[i].data.tests[j].name, cutoff: studies[i].data.tests[j].cutoff};
                            newstudy.tests.push(newobj);
                        }
                        newstudy.width = studies[i].data.width;
                        newstudy.height = studies[i].data.height;
                        newstudy.nrUsers = studies[i].data.nrUsers;
                        newstudy.thankyou = studies[i].data.thankyou;
                        newstudy.order = studies[i].data.order; 
                        newstudy.resultsCount = 0;
                        newstudy.conditions = [];
                        for (var j=0; j<studies[i].data.conditions.length; j++){
                            var oldobj = studies[i].data.conditions[j];
                            var newobj = {viewer:oldobj.viewer, dataset:oldobj.dataset, task:oldobj.task};
                            newstudy.conditions.push(newobj);
                        }

                        updateStudyDataOnServer(true, "none", newstudy, function(success, errorMsg) {
                            if (success) {
                                var icon = createStudyIcon(newstudy);
                                $("#homediv_studysection").append(icon);
                                studies.push(icon);
                                addButtonHandlers();
                                addHometileHandlers();
                            }
                            else
                                alert("Something went wrong: " + errorMsg);
                        });

                    }
            }

            function addNewStudy() {
                //create a new empty study obj
                var newstudy = new Object();
                
                newstudy.viewers = [];
                newstudy.viewerDesign = "Between subjects";
                newstudy.datasets = [];               
                newstudy.dataDesign = "Between subjects";
                newstudy.tasks = [{name: "Select", count: "1", time: "60", training: "1"}];
                newstudy.taskDesign = "Between subjects";
                newstudy.entryTasks = [];
                newstudy.exitTasks = [];
                newstudy.intros = [];
                newstudy.tests = [];
                newstudy.width = "800";
                newstudy.height = "600";
                newstudy.name = "newstudy_" + new Date().getTime();
                newstudy.resultsCount = 0;
                newstudy.conditions = [];
                newstudy.nrUsers = 10;
                newstudy.thankyou = "Default";
                newstudy.order = "Viewer,Data,Task";

                updateStudyDataOnServer(true, "none", newstudy, function(success, errorMsg) {
                  
                    if (success) {
                        var icon = createStudyIcon(newstudy);
                        $("#homediv_studysection").append(icon);
                        studies.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }


            function createViewerIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "viewer";
                icon.id = "viewericon_" + data.name;

                icon.innerHTML = createViewerIconContent(data);
                icon.className = "hometile viewertile";

                return icon;
            }

            function updateViewerIcon(icon, data) {
                icon.innerHTML = createViewerIconContent(data);
                icon.id = data.name;
                addButtonHandlers();
            }

            function createViewerIconContent(data) {
                var html = "<span class='incomplete' " + (isViewerComplete(data) === null ? "style='display:none '" : "");
                
                var shortDescription = data.description.length < 80 ? data.description : (data.description.substring(0,77) + "..."); 
        
                html += "title='Your viewer and/or some of its resources are incompletely defined'>" + 
                        "<img src='exclamation-icon.png' width=14 height=14></img></span>&nbsp" + data.name + "<br>" +
                        "<div class='smallesttext' style='max-width:150px' title='" + data.description + "'>" + 
                        shortDescription + "</div>";
                //create buttons
                html += "<div style='text-align:right'>";
                html += "<span class=button id=home_||_delviewer_||_" + data.name + ">"
                        + "<a onclick=\"removeViewer('" + data.name + "')\">"
                        + "<img src='x-icon.png' height=12 width=12>"
                        + "</a></span>";
                return html;
            }

            function checkAllStudyCompletness() {
                for (var i = 0; i < studies.length; i++)
                    if (isStudyComplete(studies[i].data) !== null)
                        $(studies[i]).find(".incomplete").show();
                    else
                        $(studies[i]).find(".incomplete").hide();
            }

            function removeViewer(viewerName) {
                var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeViewerFile(viewerName, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success)                         
                                $("#viewericon_" +viewerName).remove();
                         
                    });

                }

            }


            function addNewViewer() {
                //create a new empty viewer obj
                var newviewer = new Object();
                newviewer.name = "newviewer_" + new Date().getTime();
                newviewer.description = "";
                newviewer.source = "";
                newviewer.synopsis = "";
                newviewer.introduction = "";

                updateViewerDataOnServer(true, "none", newviewer, function(success, errorMsg) {
                    if (success) {
                        var icon = createViewerIcon(newviewer);
                        $("#homediv_viewersection").append(icon);
                        viewers.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }

            function createDatasetIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "dataset";
                icon.id = "dataseticon_" + data.name;

                icon.innerHTML = createDatasetIconContent(data);
                icon.className = "hometile datasettile";

                return icon;
            }

            function updateDatasetIcon(icon, data) {
                icon.innerHTML = createDatasetIconContent(data);
                icon.id = "dataseticon_" + data.name;
                addButtonHandlers();
            }

            function createDatasetIconContent(data) {
                var html = "<span class='incomplete' " + (isDatasetComplete(data) === null ? "style='display:none '" : "");
                var shortDescription = data.description.length < 80 ? data.description : (data.description.substring(0,77) + "..."); 
                html += "title='Your datasety and/or some of its ingredients are incompletely defined'>"+
                        "<img src='exclamation-icon.png' width=14 height=14></img>" + 
                        "</span>&nbsp" + data.name + "<br>" + 
                        "<div class='smallesttext' style='max-width:150px' title='" + data.description + "'>" + shortDescription + "</div>";
                //create buttons
                html += "<div style='text-align:right'>";
                
                html += "<span class=button id=home_||_deldataset_||_" + data.name + ">"
                        + "<a onclick=\"removeDataset('" + data.name + "')\">"
                        + "<img src='x-icon.png' height=12 width=12>"
                        + "</a></span>";
                return html;
            }

            function removeDataset(datasetName) {
      
                 var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeDatasetFile(datasetName, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success){                        
                            $("#dataseticon_" +datasetName).remove();
                         }
                    });
                }
            }

            function addNewDataset() {
                //create a new empty data obj
                var newdata = new Object();
                newdata.name = "newdata_" + new Date().getTime();
                newdata.description = "";
                newdata.sourceDirectory = "Select";
                newdata.sourceFile = "Select";

                updateDatasetDataOnServer(true, "none", newdata, function(success, errorMsg) {
                    if (success) {
                        var icon = createDatasetIcon(newdata);
                        $("#homediv_datasetsection").append(icon);
                        datasets.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }


            function createTaskprotoIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "taskproto";
                icon.id = "taskprotoicon_" + data.name;

                icon.innerHTML = createTaskprotoIconContent(data);
                icon.className = "hometile taskprototile";

                return icon;
            }

            function updateTaskprotoIcon(icon, data) {
                icon.innerHTML = createTaskprotoIconContent(data);
                icon.id = "taskprotoicon_" + data.name;
                addButtonHandlers();
            }

            function createTaskprotoIconContent(data) {
                var html = "<span class='incomplete' " + (isTaskprotoComplete(data) === null ? "style='display:none '" : "");
                var shortDescription = data.description.length < 80 ? data.description : (data.description.substring(0,77) + "..."); 
                html += "title='Your task and/or some of its ingredients are incompletely defined'>" + 
                        "<img src='exclamation-icon.png' width=14 height=14></img></span>&nbsp" + data.name + "<br>" +
                        "<div class='smallesttext' style='max-width:150px' title='" + data.description + "'>" + 
                        shortDescription + "</div>";
                //create buttons
                html += "<div style='text-align:right'>";
                html += "<span class=button id=home_||_deltaskproto_||_" + data.name + ">"
                        + "<a onclick=\"removeTaskproto('" + data.name + "')\">"
                        + "<img src='x-icon.png' height=12 width=12>"
                        + "</a></span>";
                return html;
            }

            function removeTaskproto(which) {
                var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeTaskprotoFile(which, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success){                        
                            $("#taskprotoicon_" +which).remove();
                         }
                    });
                }
            }
            function addNewTaskproto() {
                //create a new empty task obj
                var newtask = new Object();
                newtask.name = "newtask_" + new Date().getTime();
                newtask.description = "";
                newtask.question = "";
                newtask.inputs = [];
                newtask.answer = {type: "Number", correctness: "no"};

                updateTaskprotoDataOnServer(true, newtask, function(success, errorMsg) {
                    if (success) {
                        var icon = createTaskprotoIcon(newtask);
                        $("#homediv_taskprotosection").append(icon);
                        taskprotos.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }


            function createTaskinstanceIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "taskinstance";
                icon.id = "taskinstanceicon_" + data.taskproto + "_" + data.dataset;;
                
                icon.innerHTML = createTaskinstanceIconContent(data);
                icon.className = "hometile taskinstancetile";

                return icon;
            }

            function updateTaskinstanceIcon(icon, data) {
                icon.innerHTML = createTaskinstanceIconContent(data);
                icon.id = "taskinstanceicon_" + data.taskproto + "_" + data.dataset;
                addButtonHandlers();
            }

            function createTaskinstanceIconContent(data) {
                var html = "Task:" + data.taskproto + "<br>" + "Dataset:" + data.dataset + "<br>" + data.instanceCount + " instances";
                html += "<div style='text-align:right'>";
                html += "<span class=button id=home__deltaskinstance__" + data.taskproto + "__" + data.dataset + "__" + data.viewer + ">"
                        + "<a onclick=\"removeTaskInstance('" + data.taskproto + "','" + data.dataset + "','" + data.viewer + "')\"> <img src='x-icon.png' height=12 width=12> </a> </span>";

                return html;
            }


            function removeTaskInstance(taskproto, dataset, viewer) {
                removeTaskInstanceFile(taskproto, dataset, viewer, function(success) {
                    //we will remove the taskinstance widget from the gui.
                    if (success){
                       $("#taskinstanceicon_"+taskproto + "_" + dataset).remove();
                       for (var i=0; i<taskinstances.length; i++)
                           if (taskinstances[i].data.taskproto === taskproto && taskinstances[i].data.dataset === dataset){
                               taskinstances.splice(i,1);
                               break;
                           }
                   }
                    
                });

            }

            function addNewTaskinstance() {

                //this is a little different; a task instance icon in the home view should only exist if task instances of
                //this type (i.e. dataset x task) exist. So, we first allow the user to create such instances, but when they click
                //done in the task instance form, we check, and if they didn't create any instances we dont create an icon.

                var newtasks = new Object();
                newtasks.dataset = "no data";
                newtasks.taskproto = "Select";
                newtasks.viewer = "no viewer";
                newtasks.instanceCount = 0;

                $("#homediv").slideUp(200, function() {
                    $("#homedivheader").animate({opacity: '0.5'}, 300, function() {
                        $("#homedivheader").animate({opacity: '1'}, 300, function() {
                            $("#taskinstanceform").show(300);
                        });
                    });
                });

                currentTaskinstance = createTaskinstanceIcon(newtasks);
                currentTaskinstance.data = newtasks;
                putTaskinstanceDataInForm(newtasks);
            }

            function createIntroIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "intro";
                icon.id = "introicon_" + data.name;

                icon.innerHTML = createIntroIconContent(data);
                icon.className = "hometile introtile";

                return icon;
            }

            function updateIntroIcon(icon, data) {
                icon.innerHTML = createIntroIconContent(data);
                icon.id = "introicon_" + data.name;
                addButtonHandlers();
            }

            function createIntroIconContent(data) {
                var html = "<span class='incomplete' " + (isIntroComplete(data) === null ? "style='display:none '" : "");
                var shortDescription = data.description.length < 80 ? data.description : (data.description.substring(0,77) + "..."); 
                html += "title='Your intro and/or some of its resources are incompletely defined'>" + 
                        "<img src='exclamation-icon.png' width=14 height=14></img></span>&nbsp" + data.name + "<br>" + 
                        "<div class='smallesttext' style='max-width:150px' title='" + data.description + "'>" + shortDescription + "</div>";
                //create buttons
                html += "<div style='text-align:right'>";
                html += "<span class=button id=home_||_delintro_||_" + data.name + ">"
                        + "<a onclick=\"removeIntro('" + data.name + "')\">"
                        + "<img src='x-icon.png' height=12 width=12>"
                        + "</a></span>";
                return html;
            }

            function removeIntro(which) {
               var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeIntroFile(which, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success){                        
                            $("#introicon_" +which).remove();
                         }
                    });
                }
            }
            function addNewIntro() {
                //create a new empty test obj
                var newintro = new Object();
                newintro.name = "newintro_" + new Date().getTime();
                newintro.description = "";
                newintro.sourceDirectory = "Select";
                newintro.sourceFile = "Select";

                updateIntroDataOnServer(true, "none", newintro, function(success, errorMsg) {
                    if (success) {
                        var icon = createIntroIcon(newintro);
                        $("#homediv_introsection").append(icon);
                        intros.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }

            function createTestIcon(data) {

                var icon = document.createElement("div");
                icon.data = data;
                icon.tileType = "test";
                icon.id = "testicon_" + data.name;

                icon.innerHTML = createTestIconContent(data);
                icon.className = "hometile testtile";

                return icon;
            }

            function updateTestIcon(icon, data) {
                icon.innerHTML = createTestIconContent(data);
                icon.id = "testicon_" + data.name;
                addButtonHandlers();
            }

            function createTestIconContent(data) {
                var html = "<span class='incomplete' " + (isTestComplete(data) === null ? "style='display:none '" : "");
                var shortDescription = data.description.length < 80 ? data.description : (data.description.substring(0,77) + "...");                 
                html += "<span class='incomplete' title='Your standardized test and/or some of its resources are incompletely defined'>" + 
                        "<img src='exclamation-icon.png' width=14 height=14></img></span>&nbsp" + data.name + "<br>" + 
                        "<div class='smallesttext' style='max-width:150px' title='" + data.description + "'>" + shortDescription + "</div>";
                //create buttons
                html += "<div style='text-align:right'>";
                html += "<span class=button id=home_||_deltest_||_" + data.name + ">"
                        + "<a onclick=\"removeTest('" + data.name + "')\">"
                        + "<img src='x-icon.png' height=12 width=12></a></span>";
                return html;
            }

            function removeTest(testName) {

                var delDecision = confirm('Are you sure you want to delete this item?');

                if (delDecision == true) {
                    removeTestFile(testName, function(success) {
                        //we will remove the viewer widget from the gui.
                          if(success){                        
                            $("#testicon_" +testName).remove();
                         }
                    });
                }


            }
            function addNewTest() {
                //create a new empty test obj
                var newtest = new Object();
                newtest.name = "newtest_" + new Date().getTime();
                newtest.description = "";
                newtest.sourceDirectory = "Select";
                newtest.sourceFile = "Select";

                updateTestDataOnServer(true, "none", newtest, function(success, errorMsg) {
                    if (success) {
                        var icon = createTestIcon(newtest);
                        $("#homediv_testsection").append(icon);
                        tests.push(icon);
                        addButtonHandlers();
                        addHometileHandlers();
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }



            ////////////////////////////////       STUDY FORM   /////////////////////////////////////////////////////

            function putStudyDataInForm(which) {

                //NOTE: if the study already has results, then it shouldn't be possible to edit it anymore!

                $("#studyform_name").val(which.name);


                $("#studyform_viewers").html("");
                for (var i = 0; i < which.viewers.length; i++) {
                    var viewerId = createEmptyViewerRow();

                    $("#studyform_viewerselect_" + viewerId).val(which.viewers[i]);
                    if ($("#studyform_viewerselect_" + viewerId).val() === null || $("#studyform_viewerselect_" + viewerId).val().trim() === "")
                        $("#studyform_viewerselect_" + viewerId).val("Select");
                }
                 
                $("#studyform_viewerdesign").val(which.viewerDesign);

                $("#studyform_datasets").html("");
                for (var i = 0; i < which.datasets.length; i++) {
                    var dataId = createEmptyDatasetRow();

                    $("#studyform_datasetselect_" + dataId).val(which.datasets[i]);
                    if ($("#studyform_datasetselect_" + dataId).val() === null || $("#studyform_datasetselect_" + dataId).val().trim() === "")
                        $("#studyform_datasetselect_" + dataId).val("Select");
                }

                $("#studyform_datasetdesign").val(which.dataDesign);
                
                $("#studyform_taskdesign").val(which.taskDesign);
                
                $("#studyform_order").val(which.order);
                
                populateConditionsFromStudy(which);

                // create the task list
                $("#studyform_tasks").html("");
                for (var i = 0; i < which.tasks.length; i++) {
                    var taskId = createEmptyTaskRow();

                    $("#studyform_taskselect_" + taskId).val(which.tasks[i].name);
                    if ($("#studyform_taskselect_" + taskId).val() === null || $("#studyform_taskselect_" + taskId).val().trim() === "")
                        $("#studyform_taskselect_" + taskId).val("Select");
                    $("#studyform_tasknrquestions_" + taskId).val(which.tasks[i].count);
                    $("#studyform_tasktime_" + taskId).val(which.tasks[i].time);
                    $("#studyform_tasktraining_" + taskId).val(which.tasks[i].training);
                }

                // create the entry task list
                $("#studyform_entrytasks").html("");
                for (var i = 0; i < which.entryTasks.length; i++) {
                    var taskId = createEmptyEntrytaskRow();
                    $("#studyform_entrytaskselect_" + taskId).val(which.entryTasks[i]);
                    if ($("#studyform_entrytaskselect_" + taskId).val() === null || $("#studyform_entrytaskselect_" + taskId).val().trim() === "")
                        $("#studyform_entryselect_" + taskId).val("Select");
                }
                // create the exit task list
                $("#studyform_exittasks").html("");
                for (var i = 0; i < which.exitTasks.length; i++) {
                    var taskId = createEmptyExittaskRow();
                    $("#studyform_exittaskselect_" + taskId).val(which.exitTasks[i]);
                    if ($("#studyform_exittaskselect_" + taskId).val() === null || $("#studyform_exittaskselect_" + taskId).val().trim() === "")
                        $("#studyform_exittaskselect_" + taskId).val("Select");
                }

                //create the intro list
                $("#studyform_intros").html("");
                for (var i = 0; i < which.intros.length; i++) {
                    var introId = createEmptyIntroRow();
                    $("#studyform_introselect_" + introId).val(which.intros[i].name);
                    if ($("#studyform_introselect_" + introId).val() === null || $("#studyform_introselect_" + introId).val().trim() === "")
                        $("#studyform_introselect_" + introId).val("Select");
                    $("#studyform_intromatch_" + introId).val(which.intros[i].match);
                    if ($("#studyform_intromatch_" + introId).val() === null || $("#studyform_intromatch_" + introId).val().trim() === "")
                        $("#studyform_intromatch_" + introId).val("All");
                }
                
                //create the thankyou                
                var html = "<option value=Default selected>Default</option>";
                for (var j = 0; j < intros.length; j++)
                    html += "<option value=" + intros[j].data.name + ">" + intros[j].data.name + "</option>"; 
                $("#studyform_thankyou").html(html);
                $("#studyform_thankyou").val(which.thankyou);
                if ($("#studyform_thankyou").val() === null || $("#studyform_thankyou").val().trim() === "")
                        $("#studyform_thankyou" + introId).val("Select");
                

                //create the thank you list
                $("#studyform_tests").html("");
                for (var i = 0; i < which.tests.length; i++) {
                    var testId = createEmptyTestRow();
                    $("#studyform_testselect_" + testId).val(which.tests[i].name);
                    if ($("#studyform_testselect_" + testId).val() === null || $("#studyform_testselect_" + testId).val().trim() === "")
                        $("#studyform_testselect_" + testId).val("Select");
                    $("#studyform_cutoff_" + testId).val(which.tests[i].cutoff);
                }
                

                //put the height and width
                $("#studyform_width").val(which.width);
                $("#studyform_height").val(which.height);


                //NOTE: if the study already has results, then it shouldn't be possible to edit it anymore!
                $("studyform_cannotbeedited").hide();
                
                if (which.resultsCount !== 0) {
                    
                    $("studyform_cannotbeedited").show();
                    $("#studyform").find("input").attr("disabled", true);
                    $("#studyform").find("select").attr("disabled", true);
                    $("#studyform").find(".button").addClass("buttoninactive");
                    $(document.getElementById("studyform_||_done_||_1")).removeClass("buttoninactive");
                    $(document.getElementById("studyform_||_done_||_2")).removeClass("buttoninactive");
                    $(document.getElementById("studyform_||_demo")).removeClass("buttoninactive");
                    $(document.getElementById("studyform_||_getalink")).removeClass("buttoninactive");
                }

                addButtonHandlers();
            }



            //saves the information from the study form onto the server
            function saveStudyUpdates() {

                var studyObject = putFormIntoStudyObject();

                updateStudyDataOnServer(false, currentStudy.data.name, studyObject, function(success, errorMsg) {
                    if (success) {
                        currentStudy.data = studyObject; //update the actual study data item (currentStudy.data)
                        updateStudyIcon(currentStudy, studyObject);//update the icon in home (currentStudy)

                        if (isStudyComplete(studyObject) != null)
                            $(currentStudy).find(".incomplete").show();
                        else
                            $(currentStudy).find(".incomplete").hide();

                        $("#studyform").hide(200, function() {
                            $("#homediv").slideDown(200);
                            currentStudy = null;
                        });
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });
            }




            function validateStudyForm() {

                if ($("#studyform_name").val().trim() == "") {
                    alert("Please provide a name for your study");
                    return false;
                }

                return true;
            }

            function putFormIntoStudyObject() {
                var study = new Object();
         
                study.resultsCount = currentStudy.data.resultsCount;

                study.name = $("#studyform_name").val();

                study.viewers = [];
                //NB viewers are objects and they have name
                $("#studyform_viewers").children().each(function() {
                    study.viewers.push($(this).find('select').val());
                });

                study.viewerDesign = $("#studyform_viewerdesign").val();

                study.datasets = [];
                //NB datasets are objects
                $("#studyform_datasets").children().each(function() {
                    study.datasets.push($(this).find('select').val());
                });

                study.dataDesign = $("#studyform_datasetdesign").val();
                                
                study.taskDesign = $("#studyform_taskdesign").val();
                
                study.order = $("#studyform_order").val();
                
                study.conditions = [];
                for (var i=0; i<$("#studyform_conditions")[0].children.length; i++){
                    var div = $("#studyform_conditions")[0].children[i];
                    study.conditions.push({viewer: div.viewer, dataset : div.datas, task: div.task});
                 }
                 
                study.userGroups = [];
                for (var i=0; i<$("#studyform_groupings")[0].groupings.length; i++)
                    study.userGroups.push({conditions:$("#studyform_groupings")[0].groupings[i]});
                 
                 study.nrUsers = $("#studyform_nrusers").val();

                study.tasks = [];
                $("#studyform_tasks").children().each(function() {
                    var id = $(this).attr("id").split("_")[2];
                    var taskobj = new Object();
                    taskobj.name = $(this).find("#studyform_taskselect_" + id).val();
                    taskobj.count = $(this).find("#studyform_tasknrquestions_" + id).val();
                    taskobj.time = $(this).find("#studyform_tasktime_" + id).val();
                    taskobj.training = $(this).find("#studyform_tasktraining_" + id).val();
                    study.tasks.push(taskobj);
                });

                study.entryTasks = [];
                //NB: entry tasks are objects too.
                $("#studyform_entrytasks").children().each(function() {                    
                    var id = $(this).attr("id").split("_")[2];                    
                    study.entryTasks.push($(this).find("#studyform_entrytaskselect_" + id).val());
                });

                study.exitTasks = [];
                //NB: exit tasks are objects too
                $("#studyform_exittasks").children().each(function() {
                   var id = $(this).attr("id").split("_")[2];
                   study.exitTasks.push($(this).find("#studyform_exittaskselect_" + id).val());
                });

                study.intros = [];
                $("#studyform_intros").children().each(function() {
                    var id = $(this).attr("id").split("_")[2];
                    var introobj = new Object();
                    introobj.name = $(this).find("#studyform_introselect_" + id).val();
                    introobj.match = $(this).find("#studyform_intromatch_" + id).val();
                    study.intros.push(introobj);
                });
                
                study.thankyou = $("#studyform_thankyou").val();

                study.tests = [];
                $("#studyform_tests").children().each(function() {
                    var id = $(this).attr("id").split("_")[2];
                    var studyName = $(this).find("#studyform_testselect_" + id).val();
                    var cutff = $(this).find("#studyform_cutoff_" + id).val();
                    study.tests.push({name:studyName,cutoff:cutff});
                });

                study.width = $("#studyform_width").val();
                study.height = $("#studyform_height").val();

                return study;
            }


            function studyFormAction(split) {
                if (split[1] == "done") {
                    if (validateStudyForm()) {
                        saveStudyUpdates();  //save changes to server; update study icon in home; hide study form
                    }
                    ;
                }
                else if (split[1] == "taskup") {
                    var taskToMove = $("#studyform_task_" + split[2]);
                    var allButtons = $(".button");

                    if (taskToMove.prevAll().length == 0)  //task already at the top
                        return;

                    taskToMove.css("background-color", "rgba(100,100,100,0.5"); //highlight the moving task a bit

                    taskToMove.slideUp(250, function() {			//remove it from its current position visually

                        var prev = taskToMove.prev();
                        allButtons.removeClass("buttonover");			//buttons were accidentaly marked as hovered...

                        taskToMove.detach(); 						//remove it from its currrent position acutally				
                        prev.before(taskToMove[0]);					//insert it into the new position (before it's previous sibling)

                        taskToMove.slideDown(250, function() {		//add it back to the DOM
                            allButtons.removeClass("buttonover");

                            window.setTimeout(function() {			//finally, a little later remove the highlighting
                                $("#studyform_task_" + split[2]).css("background-color", "");
                            }, 500);
                        });
                    });


                }
                else if (split[1] == "taskdown") {

                    var taskToMove = $("#studyform_task_" + split[2]);
                    var allButtons = $(".button");

                    if (taskToMove.nextAll().length == 0)  //task already at the top
                        return;

                    taskToMove.css("background-color", "rgba(100,100,100,0.5"); //highlight the moving task a bit

                    taskToMove.slideUp(250, function() {			//remove it from its current position visually

                        var next = taskToMove.next();
                        allButtons.removeClass("buttonover");			//buttons were accidentaly marked as hovered...

                        taskToMove.detach(); 						//remove it from its currrent position acutally				
                        next.after(taskToMove[0]);					//insert it into the new position (after it's next sibling)

                        taskToMove.slideDown(250, function() {		//add it back to the DOM
                            allButtons.removeClass("buttonover");

                            window.setTimeout(function() {			//finally, a little later remove the highlighting
                                $("#studyform_task_" + split[2]).css("background-color", "");
                            }, 500);
                        });
                    });
                }

                else if (split[1] == "addviewer") {
                    createEmptyViewerRow();
                    addButtonHandlers();
                }
                else if (split[1] == "adddataset") {
                    createEmptyDatasetRow();
                    addButtonHandlers();
                }
                else if (split[1] == "addtask") {
                    createEmptyTaskRow();
                    addButtonHandlers();
                }
                else if (split[1] == "addentrytask") {
                    createEmptyEntrytaskRow();
                    addButtonHandlers();
                }
                else if (split[1] == "addexittask") {
                    createEmptyExittaskRow();
                    addButtonHandlers();
                }
                else if (split[1] == "addintro") {
                    createEmptyIntroRow();
                    addButtonHandlers();
                }
                else if (split[1] == "addtest") {
                    createEmptyTestRow();
                    addButtonHandlers();
                }
                else if (split[1] == "delviewer") {
                    if ($("#studyform_viewers").children().length == 1)
                        return;
                    var viewerId = split[2];
                    $("#studyform_viewerrow_" + viewerId).remove();
                    updateIntroSelects();
                }
                else if (split[1] == "deldataset") {
                    if ($("#studyform_datasets").children().length == 1)
                        return;
                    var datasetId = split[2];
                    $("#studyform_datasetrow_" + datasetId).remove();
                    datasetsChanged();
                }
                else if (split[1] == "deltask") {               
                    if ($("#studyform_tasks").children().length == 1)
                        return;
                    var taskId = split[2];
                    $("#studyform_task_" + taskId).remove();
                    tasksChanged();
                }
                else if (split[1] == "delentrytask") {
                    var taskId = split[2];
                    $("#studyform_entrytask_" + taskId).remove();
                }
                else if (split[1] == "delexittask") {
                    var taskId = split[2];
                    $("#studyform_exittask_" + taskId).remove();
                }
                else if (split[1] == "demo") {
                    var obj = putFormIntoStudyObject();
                    var complete = isStudyComplete(obj);
                    if (complete == null)
                        demoStudy(obj);
                    else
                        alert("Your study is not yet completely specified. " + complete);
                }
                else if (split[1] == "getalink") {
                    var obj = putFormIntoStudyObject();
                    var complete = isStudyComplete(obj);
                    if (complete == null)
                        getStudyLink(obj);
                    else
                        alert("Your study is not yet completely specified. " + complete);
                }
            }

            function createEmptyViewerRow() {
                uniqueViewerId++;
                var html = "<div id='studyform_viewerrow_" + uniqueViewerId + "' style='margin-bottom:5px' class='inputrow'>";
                html += "<table><tr><td>";
                html += "<div class='inputlabel'>Viewer name</div>";
                html += "<select style='width:100%' id='studyform_viewerselect_" + uniqueViewerId + "'>";
                html += "<option selected value='Select'> Select </option>";
                for (var j = 0; j < viewers.length; j++)
                    html += "<option val='" + viewers[j].data.name + "'>" + viewers[j].data.name + "</option>";
                html += "</select></td>";
                html += "<td style='text-align:right'><span class='button' id='studyform_||_delviewer_||_" + uniqueViewerId + "'> <img src='x-icon.png' height=12 width=12> </span></td></div>";
                $("#studyform_viewers").append(html);

                //add event handler for selection change
                $("#studyform_viewerselect_" + uniqueViewerId).change(function() {
                    viewersChanged();
                });
                return uniqueViewerId;
            }
            function createEmptyDatasetRow() {
                uniqueDatasetId++;
                var html = "<div id='studyform_datasetrow_" + uniqueDatasetId + "' style='margin-bottom:5px' class='inputrow'>";
                html += "<table><tr><td>"
                html += "<div class='inputlabel'>Dataset name</div>";
                html += "<select style='width:100%' id='studyform_datasetselect_" + uniqueDatasetId + "'>";
                html += "<option selected value='Select'> Select </option>";
                for (var j = 0; j < datasets.length; j++)
                    html += "<option>" + datasets[j].data.name + "</option>";
                html += "</select></td>";
                html += "<td style='text-align:right'<span class='button' id='studyform_||_deldataset_||_" + uniqueDatasetId + "'> <img src='x-icon.png' height=12 width=12> </span> </td></div>";
                $("#studyform_datasets").append(html);
                
                //add event handler for selection change
                $("#studyform_datasetselect_" + uniqueDatasetId).change(function() {
                    datasetsChanged();
                });
                
                return uniqueDatasetId;
            }
            function createEmptyTaskRow() {
                uniqueTaskId++;

                var html = "<div style='margin-bottom:10px; padding: 10px 5px 10px 5px' class='inputrow' id='studyform_task_" + uniqueTaskId + "'>";

                html += "<table><tr><td>";
                //create the up and down buttons
                html += "<span class='button' id='studyform_||_taskup_||_" + uniqueTaskId + "' padding: 0px 0px 0px 0px><img src='up-icon.png' width=12 height=12></img></span>";
                html += "<span class='button' id='studyform_||_taskdown_||_" + uniqueTaskId + "' padding: 0px 0px 0px 0px><img src='down-icon.png' width=12 height=12></img></span>";
                html += "</td>";

                //create the selection box with the correct task selected
                html += "<td><div class='inputlabel'>Task name<div><select id='studyform_taskselect_" + uniqueTaskId + "' onchange='tasksChanged()'><option value='Select' selected'>Select</option>";
                for (var j = 0; j < taskprotos.length; j++)
                    html += "<option>" + taskprotos[j].data.name + "</option>";
                html += "</select></td>";

                //create the number of questions box
                html += "<td><div class='inputlabel'>How many?</div><input type='number' min=1 value='1' style='width:60px' id='studyform_tasknrquestions_" + uniqueTaskId + "'></input></td>";

                //create the number of seconds box
                html += "<td><div class='inputlabel'>Max time (sec)</div><input type='number' min=1 value='60' style='width:80px' id='studyform_tasktime_" + uniqueTaskId + "'></input></td>";

                //create the number of questions box
                html += "<td><div class='inputlabel'>Training tasks</div><input type='number' min=0 value='1' style='width:75px' id='studyform_tasktraining_" + uniqueTaskId + "'></input><td>";

                //create the delete task button
                html += "<td><span class='button' id='studyform_||_deltask_||_" + uniqueTaskId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";

                html += "</tr></table></div>";
                $("#studyform_tasks").append(html);
                addButtonHandlers();

                return uniqueTaskId;
            }


            function createEmptyEntrytaskRow() {
                uniqueEntrytaskId++;

                var html = "<div style='margin-bottom:10px; padding: 10px 5px 10px 5px' class='inputrow' id='studyform_entrytask_" + uniqueEntrytaskId + "'>";

                html += "<table><tr>";

                //create the selection box with the correct task selected
                html += "<td><div class='inputlabel'>Task name<div><select id='studyform_entrytaskselect_" + uniqueEntrytaskId + "'><option value='Select' selected>Select</option>";
                for (var j = 0; j < taskprotos.length; j++)
                    html += "<option>" + taskprotos[j].data.name + "</option>";
                html += "</select></td>";

                //create the delete task button
                html += "<td><span class='button' id='studyform_||_delentrytask_||_" + uniqueEntrytaskId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";

                html += "</tr></table></div>";
                $("#studyform_entrytasks").append(html);
                addButtonHandlers();

                return uniqueEntrytaskId;
            }


            function createEmptyExittaskRow() {
                uniqueExittaskId++;

                var html = "<div style='margin-bottom:10px; padding: 10px 5px 10px 5px' class='inputrow' id='studyform_exittask_" + uniqueExittaskId + "'>";

                html += "<table><tr>";

                //create the selection box with the correct task selected
                html += "<td><div class='inputlabel'>Task name<div><select id='studyform_exittaskselect_" + uniqueExittaskId + "'><option value='Select' selected>Select</option>";
                for (var j = 0; j < taskprotos.length; j++)
                    html += "<option>" + taskprotos[j].data.name + "</option>";
                html += "</select></td>";

                //create the delete task button
                html += "<td><span class='button' id='studyform_||_delexittask_||_" + uniqueExittaskId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";

                html += "</tr></table></div>";
                $("#studyform_exittasks").append(html);
                addButtonHandlers();

                return uniqueExittaskId;
            }



            function createEmptyIntroRow() {
                uniqueIntroId++;

                var html = "<div style='margin-bottom:10px; padding: 10px 5px 10px 5px' class='inputrow' id='studyform_intro_" + uniqueIntroId + "'>";

                //create the selection box
                html += "<table><tr><td>";
                html += "<div class='inputlabel'>Intro name</div>";
                html += "<select id='studyform_introselect_" + uniqueIntroId + "'><option selected value='Select'>Select</option>";

                for (var j = 0; j < intros.length; j++)
                    html += "<option>" + intros[j].data.name + "</option>";

                html += "</select></td>";

                //create the condition match selection
                html += "<td><div class='inputlabel'>Show to group</div>";
                html += "<select style='width:100px' id='studyform_intromatch_" + uniqueIntroId + "' class='intromatchselect'><option selected value='All'>All</option>";
                //get as options whatever the viewers are
                var sv = getUserGroups();
                
                for (var i = 0; i < sv.length; i++)
                    html += "<option val='" + (i+1) + "'>" + (i+1) + "</option>";

                html += "</select></td>";

                //create the delete task button
                html += "<td style='text-align:right'><span class='button' id='studyform_||_delintro_||_" + uniqueIntroId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";

                html += "</tr></table></div>";
                $("#studyform_intros").append(html);
                addButtonHandlers();

                return uniqueIntroId;
            }
            function getSelectedViewers() {
                var result = [];
                $("#studyform_viewers").children().each(function(i) {
                    var val = $(this).find("select").val();
                    if (val != "Select")
                        result.push(val);
                });
                return result;
            }
            function getSelectedDatasets() {
                var result = [];
                $("#studyform_datasets").children().each(function(i) {
                    var val = $(this).find("select").val();
                    if (val != "Select")
                        result.push(val);
                });
                return result;
            }
            function getSelectedTasks() {
                var result = [];
                $("#studyform_tasks").children().each(function(i) {
                    var val = $(this).find("select").val();
                    if (val != "Select")
                        result.push(val);
                });
                return result;
            }
            
            function getUserGroups(){
                return $("#studyform_groupings")[0].groupings;
            }
            
            function userGroupsChanged(){
                var sv = getUserGroups();
                var html = "<option val='Select' selected>Select</option><option val='All'>All</option>";
                for (var i = 0; i < sv.length; i++)
                    html += "<option val='" + (i+1) + "'>" + (i+1) + "</option>";
                $(".intromatchselect").each(function() {
                    var currentSel = $(this).val();
                    $(this).html(html);
                    $(this).val(currentSel);
                    if ($(this).val() == null)
                        $(this).val("Select");

                });
            }
            
            function viewersChanged() {                
                //two things need to happen here;
                //1: change the intro matches
                var sv = getSelectedViewers();
                var html = "<option val='Select' selected>Select</option><option val='All'>All</option>";
                for (var i = 0; i < sv.length; i++)
                    html += "<option val='" + sv[i] + "'>" + sv[i] + "</option>";
                $(".intromatchselect").each(function() {
                    var currentSel = $(this).val();
                    $(this).html(html);
                    $(this).val(currentSel);
                    if ($(this).val() == null)
                        $(this).val("Select");

                });
                //2. redo the conditions
                populateConditionsFromForm();
            }
            
            function datasetsChanged(){
                populateConditionsFromForm();
            }
            
            function tasksChanged(){
                populateConditionsFromForm();
            }
            
            function viewerDesignChanged(){
                
                populateGroupings();
            }
            function datasetDesignChanged(){
                populateGroupings();
            }
            function taskDesignChanged(){
                populateGroupings();
            }
            
            function orderChanged(){
                populateConditionsFromForm();
            }
            
            function populateConditionsFromForm(){
                
                $("#studyform_conditions").html("");
               
                //get all the viewers
                var sv = getSelectedViewers();
                var sd = getSelectedDatasets();
                var st = getSelectedTasks();
                
                var order = $("#studyform_order").val();
                var split = order.split(",");
                var arr = [];
                var getViewer, getData, getTask;
                for (var i=0; i<split.length; i++){
                    if (split[i] === "Viewer")
                        arr.push(sv);
                    if (split[i] === "Data")
                        arr.push(sd);
                    if (split[i] === "Task")
                        arr.push(st);
                }
                getViewer = function(indeces){
                    var vi = split.indexOf("Viewer");
                    return arr[vi][indeces[vi]];
                };
                getData = function(indeces){
                    var vi = split.indexOf("Data");
                    return arr[vi][indeces[vi]];
                };
                getTask = function(indeces){
                    var vi = split.indexOf("Task");
                    return arr[vi][indeces[vi]];
                };
               
                for (var i=0; i<arr[0].length; i++)
                    for (var j=0; j<arr[1].length; j++)
                        for (var k=0; k<arr[2].length; k++)
                            createConditionRow(getViewer([i,j,k]), getData([i,j,k]), getTask([i,j,k]));
                
                populateGroupings();
            }
            
             function populateConditionsFromStudy(study){
                $("#studyform_conditions").html("");
                
               
                for (var i=0; i<study.conditions.length; i++)
                    createConditionRow(study.conditions[i].viewer,study.conditions[i].dataset, study.conditions[i].task);
                
                populateGroupings();
            }
            
            function populateGroupings(){
                $("#studyform_groupings").html("");
                
                var conditions = [];
                var childs = $("#studyform_conditions")[0].children;
                for (var i=0; i<childs.length; i++)
                    conditions.push({viewer: childs[i].viewer, dataset : childs[i].datas, task : childs[i].task});
                var vd = $("#studyform_viewerdesign").val();
                var dd = $("#studyform_datasetdesign").val();
                var td = $("#studyform_taskdesign").val();
                
                
                var final = createGroups(conditions,vd,dd,td);
                
                $("#studyform_groupings")[0].groupings = [];
                var rowCnt = 1;
                for (var i=0; i<final.length; i++){  
                    var groupdiv = $("<div class='inputrow' style='margin-top:10px'></div>"); 
                    $("#studyform_groupings").append(groupdiv);
                    for (var j=0; j<final[i].length; j++){
                        var str = "";
                        var conditionsPerOrdering = [];
                        for (var k=0; k<final[i][j].length; k++){
                            conditionsPerOrdering.push({viewer:final[i][j][k].viewer, dataset:final[i][j][k].dataset, task:final[i][j][k].task});
                            str += final[i][j][k].viewer + " x " + final[i][j][k].dataset + " x " + final[i][j][k].task;
                            if (k != final[i][j].length-1) str+=", ";
                        }                      
                       
                        str = formatConditionString2(final[i][j], [true,true,true]);
                        $("#studyform_groupings")[0].groupings.push(conditionsPerOrdering);
                        var tb = $("<table width='100%'></table>"); groupdiv.append(tb);
                        var tr = $("<tr></tr>"); tb.append(tr);
                        var td0 = $("<td></td>").html(rowCnt++); tr.append(td0);
                        var td1 = $("<td class='groupInfo'>" + str + "</td>"); tr.append(td1);
                        var td2 = $("<td width='100px' align='right'>" + $("#studyform_nrusers").val() + " users</td>"); tr.append(td2);
                        
                    }
                }
            }
            
            function formatConditionString2(conditions, which){
                
               if ((which[0] || which[1] || which[2]) === false)
                   return "";
             
                var res = "";
                var needPara = false;
                
                var subcon = [];
                
                var lastV, lastD, lastT;
                var constV, constD, constT;
                for (var i=0; i<=conditions.length; i++){                   
                    if (i==0){
                        lastV = conditions[i].viewer; lastD = conditions[i].dataset; lastT = conditions[i].task;
                        subcon = [conditions[i]];
                        constV = which[0]; constD = which[1]; constT = which[2];
                    }
                    else{
                        var newConstV = false;
                        var newConstD = false;
                        var newConstT = false;
                        if (i < conditions.length){
                            var sameV = which[0] && (conditions[i].viewer === lastV);
                            var sameD = which[1] && (conditions[i].dataset === lastD);
                            var sameT = which[2] && (conditions[i].task === lastT);

                            var newConstV = sameV && constV;
                            var newConstD = sameD && constD;
                            var newConstT = sameT && constT;
                        }                        
                        
                        if (newConstV || newConstD || newConstT){ 
                            subcon.push(conditions[i]);
                            constV = newConstV;
                            constD = newConstD;
                            constT = newConstT;
                        }
                        else{                           
                            if (res.length !== 0){ needPara = true; res += ", "};
                            var s1 = (constV && which[0]) ? lastV : "";
                            var s2 = (constD && which[1]) ? lastD : "";
                            var s3 = (constT && which[2]) ? lastT : "";
                            var s4 = formatConditionString2(subcon, [!constV && which[0], !constD && which[1], !constT && which[2]]);                           
                            var s = "";
                            if (s1.length != 0) s = s1;
                            if (s2.length != 0 && s.length == 0) s = s2;
                            else if (s2.length != 0 && s.length != 0) s = s + " x " + s2;
                            if (s3.length != 0 && s.length == 0) s = s3;
                            else if (s3.length != 0 && s.length != 0) s = s + " x " + s3;
                            if (s4.length != 0 && s.length == 0) s = s4;
                            else if (s4.length != 0 && s.length != 0) s = s + " x " + s4;
                            res += s;
                            subcon = [conditions[i]];
                            if (i < conditions.length){
                                lastV = conditions[i].viewer; 
                                lastD = conditions[i].dataset; 
                                lastT = conditions[i].task;
                                constV = which[0]; constD = which[1]; constT = which[2];
                            }
                        }
                    }
                }
             
               if (needPara) res = "(" + res + ")"; 
               return res;
            }
 
 
            
            function createConditionRow(v, d, t){
                var div = $("<div></div>")
                        .attr("class", "inputrow")
                        .css("margin-bottom","10px");
                var tb = $("<table width='100%'></table>"); div.append(tb);
                var tr = $("<tr></tr>"); tb.append(tr);   
                var td1 = $("<td></td>").html(v + " x " + d + " x " + t); tr.append(td1);
                var td2 = $("<td width='13px' align=right></td>"); tr.append(td2);
                var button = $("<span><img src=x-icon.png width=12px height=12px></img></span>")
                        .attr("class", "button")
                        .click( function(div){
                            return function(){
                                div.remove();
                                populateGroupings();
                            }
                        }(div));
                addButtonHandlers();
                td2.append(button);
                $("#studyform_conditions").append(div);
                
                div[0].viewer = v;
                div[0].datas = d;
                div[0].task = t;
               
            }

            function createEmptyTestRow() {
                uniqueTestId++;

                var html = "<div style='margin-bottom:10px; padding: 10px 5px 10px 5px' class='inputrow' id='studyform_test_" + uniqueTestId + "'>";

                html += "<table><tr><td>";

                //create the selection box
                html += "<div class='inputlabel'> Test name</div>";
                html += "<select id='studyform_testselect_" + uniqueTestId + "'><option value='Select'>Select</option>";

                for (var j = 0; j < tests.length; j++)
                    html += "<option value='" + tests[j].data.name + "'>" + tests[j].data.name + "</option>";

                html += "</select></td>";
                
                html += "<td><div class='inputlabel'>Cutoff</div>" +
                        "<input type=number id='studyform_cutoff_" + uniqueTestId + "' value=0 step=0.1 max=1 min=0 style='width:30px'></td>";

                //create the delete test button
                html += "<td><span class='button' id='studyform_delintro_" + uniqueIntroId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";

                html += "</div>";
                $("#studyform_tests").append(html);
                addButtonHandlers();

                return uniqueTestId;
            }

            function demoStudy(currentStudy) {
                  var theURL = "study.html?study=" + currentStudy.name + "&user=blah&debug=true";
              window.open(theURL,'_blank');
            }

            function getStudyLink(currentStudy) {
                alert("(not implemented) getStudyLink");
            }

            //returns null if the study is complete; otherwise returns a string stating the error.
            function isStudyComplete(study) {

                var error = "";

                if (study.name.trim() === "")
                    error = "the name of your study is not set; ";

                if (study.viewers.length == 0)
                    error = "the study has no viewers; ";
                var allViewersFine = true;
                for (var i = 0; i < study.viewers.length; i++) {
                    if (study.viewers[i] === "Select")
                        allViewersFine = false;
                    for (var j = 0; !allViewersFine && j < viewers.length; j++)
                        if (viewers[j].data.name === study.viewers[i])
                            if (isViewerComplete(viewers[j].data) != null) {
                                allViewersFine = false;
                                break;
                            }
                    if (!allViewersFine)
                        break;
                }
                if (!allViewersFine)
                    error = "at least one of the selected viewers has not been fully specified or is not operational;";

                if (study.datasets.length == 0)
                    error = "the study has no datasets; ";
                var allDataFine = true;
                for (var i = 0; i < study.datasets.length; i++) {
                    if (study.datasets[i] === "Select")
                        allDataFine = false;
                    for (var j = 0; allDataFine && j < datasets.length; j++)
                        if (datasets[j].data.name === study.datasets[i])
                            if (isDatasetComplete(datasets[j].data) != null) {
                                allDataFine = false;
                                break;
                            }
                    if (!allDataFine)
                        break;
                }
                if (!allDataFine)
                    error = "at least one of the selected datasets has not been fully specified or is not operational;";


                if (study.tasks.length == 0)
                    error = "the study has no tasks; ";
                var allTasksFine = true;
                for (var i = 0; i < study.tasks.length; i++) {
                    if (study.tasks[i].name === "Select")
                        allTasksFine = false;
                    for (var j = 0; !allTasksFine && j < taskprotos.length; j++)
                        if (taskprotos[j].data.name === study.tasks[i].name)
                            if (isTaskprotoComplete(taskprotos[j].data) != null) {
                                allTasksFine = false;
                                break;
                            }
                    if (!allTasksFine)
                        break;
                }
                if (!allTasksFine)
                    error = "at least one of the selected tasks has not been fully specified or is not operational;";

                var allEntrytasksFine = true;
                for (var i = 0; i < study.entryTasks.length; i++) {
                    if (study.entryTasks[i].name === "Select")
                        allEntrytasksFine = false;
                    for (var j = 0; !allEntrytasksFine && j < taskprotos.length; j++)
                        if (taskprotos[j].data.name === study.entryTasks[i].name)
                            if (isTaskprotoComplete(taskprotos[j].data) != null) {
                                allEntrytasksFine = false;
                                break;
                            }
                    if (!allEntrytasksFine)
                        break;
                }
                if (!allEntrytasksFine)
                    error = "at least one of the selected entry tasks has not been fully specified or is not operational;";

                var allExittasksFine = true;
                for (var i = 0; i < study.exitTasks.length; i++) {
                    if (study.exitTasks[i].name === "Select")
                        allExittasksFine = false;
                    for (var j = 0; !allExittasksFine && j < taskprotos.length; j++)
                        if (taskprotos[j].data.name === study.exitTasks[i].name)
                            if (isTaskprotoComplete(taskprotos[j].data) != null) {
                                allExittasksFine = false;
                                break;
                            }
                    if (!allExittasksFine)
                        break;
                }
                if (!allExittasksFine)
                    error = "at least one of the selected exit tasks has not been fully specified or is not operational;";


                var allIntrosFine = true;
                for (var i = 0; i < study.intros.length; i++) {
                    if (study.intros[i].name === "Select")
                        allIntrosFine = false;
                    for (var j = 0; !allIntrosFine && j < intros.length; j++)
                        if (intros[j].data.name === study.intros[i].name)
                            if (isIntroComplete(intros[j].data) != null) {
                                allIntrosFine = false;
                                break;
                            }
                    if (!allIntrosFine)
                        break;
                }
                if (!allIntrosFine)
                    error = "at least one of the selected intros has not been fully specified or is not operational;";

                var allTestsFine = true;
                for (var i = 0; i < study.tests.length; i++) {
                    if (study.tests[i].name === "Select")
                        allTestsFine = false;
                    for (var j = 0; !allTestsFine && j < tests.length; j++)
                        if (tests[j].data.name === study.tests[i].name)
                            if (isTestComplete(intros[j].data) != null) {
                                allTestsFine = false;
                                break;
                            }
                    if (!allTestsFine)
                        break;
                }
                if (!allTestsFine)
                    error = "at least one of the selected standardized tests has not been fully specified or is not operational;";

                if (error.trim() === "")
                    return null;

                else
                    return "It seems that: " + error;
            }



            ////////////////////////////////   VIEWER, DATASET, INTRO, TESTS FORM   /////////////////////////////////////////////////////
            function addFormHandlers(which) {
                $("#" + which + "_sourcedirectory").change(function() {
                    var d = $("#" + which + "_sourcedirectory").val();
                    var index = -1;
                    for (var i = 0; i < directories.length; i++)
                        if (directories[i].name === d)
                            index = i;

                    if (index >= 0)
                        updateFilesSelect($("#" + which + "_sourcefile"), directories[index]);
                });
            }

            function updateDirectoriesSelect(selection) {
                var savedsel = selection.val();
                //populate the directory select; all available directory are stored in the directories variable
                selection.html("<option value='Select'>Select</option>");
                for (var i = 0; i < directories.length; i++)
                    selection.append($('<option/>', {value: directories[i].name, text: directories[i].name}));
                selection.val(savedsel);
                if (selection.val() == null)
                    selection.val("Select");
            }
            function updateFilesSelect(selection, directory) {
                var savedsel = selection.val();
                selection.html("<option value='Select'>Select</option>");
                for (var i = 0; i < directory.files.length; i++)
                    selection.append($('<option/>', {value: directory.files[i].name, text: directory.files[i].name}));
                selection.val(savedsel);
                if (selection.val() == null)
                    selection.val("Select");
            }

            function putDataInForm(form, which) {
                
                $("#" + form + "_name").val(which.name);
                $("#" + form + "_description").val(which.description);
                $("#" + form + "_source").html(which.source);
                                
                if (form === "viewerForm")
                    $("#" + form + "_intro").val(which.introduction);

                
                //take the create directories and files form, from where it is, and put it in THIS form
                var adddirform = $("#adddirform")[0];
                $("#adddirform").detach();
                $("#" + form + "_addstuff").append(adddirform);

                //link the update selection call back from the file manager to update the source here
                fileManager.selectionChanged = function(obj){
                };


            }

            function isViewerComplete(v) {

                var error = "";

                if (v.name.trim() === "")
                    error += " the viewer name is empty; ";

                if (v.source === "")
                    error += " the viewer source file is not specified; ";

                if (error.trim() === "")
                    return null;
                else
                    return "It seems that: " + error;
            }

            function isDatasetComplete(d) {
                var error = "";

                if (d.name.trim() === "")
                    error += " the dataset name is empty; ";

                if (d.source === "")
                    error += " the dataset source file is not specified; ";

                if (error.trim() === "")
                    return null;
                else
                    return "It seems that: " + error;
            }

            function isIntroComplete(v) {

                var error = "";

                if (v.name.trim() === "")
                    error += " the intro name is empty; ";

                if (v.source === "")
                    error += " the intro source file is not specified; ";

                if (error.trim() === "")
                    return null;
                else
                    return "It seems that: " + error;
            }

            function isTestComplete(v) {

                var error = "";

                if (v.name.trim() === "")
                    error += " the standardized test name is empty; ";

                if (v.source === "Select")
                    error += " the standardized test source file is not specified; ";

                if (error.trim() === "")
                    return null;
                else
                    return "It seems that: " + error;
            }


            //saves the information from the study form onto the server
            function saveUpdates(which) {

                var object = putFormIntoObject(which);

                if (which == "viewerform"){
                   var oldname = currentViewer.data.name;
                    updateViewerDataOnServer(false, oldname, object, function(success, errorMsg) {
                        if (success) {
                            currentViewer.data = object; //update the actual viewer data item (currentViewer.data)
                            updateViewerIcon(currentViewer, object);//update the icon in home (currentViewer) 
                            checkAllStudyCompletness();
                            $("#viewerform").hide(200, function() {
                                $("#homediv").slideDown(200);
                                currentViewer = null;
                            });
                        }
                        else
                            alert("Something went wrong: " + errorMsg);
                    });
                }
                if (which == "datasetform"){
                    var oldname = currentDataset.data.name;
                    updateDatasetDataOnServer(false, oldname, object, function(success, errorMsg) {
                        if (success) {
                            currentDataset.data = object;
                            updateDatasetIcon(currentDataset, object);
                            checkAllStudyCompletness();
                            $("#datasetform").hide(200, function() {
                                $("#homediv").slideDown(200);
                                currentInfo = null;
                            });
                        }
                        else
                            alert("Something went wrong: " + errorMsg);
                    });
                }
                if (which == "introform"){
                    var oldname = currentIntro.data.name;
                    updateIntroDataOnServer(false, oldname, object, function(success, errorMsg) {
                        if (success) {
                            currentIntro.data = object;
                            updateViewerIcon(currentIntro, object);
                            checkAllStudyCompletness();
                            $("#introform").hide(200, function() {
                                $("#homediv").slideDown(200);
                                currentInfo = null;
                            });
                        }
                        else
                            alert("Something went wrong: " + errorMsg);
                    });
                }
                if (which == "testform"){
                    var oldname = currentTest.data.name;
                    updateTestDataOnServer(false, oldname, object, function(success, errorMsg) {
                        if (success) {
                            currentTest.data = object;
                            updateTestIcon(currentTest, object);
                            checkAllStudyCompletness();
                            $("#testform").hide(200, function() {
                                $("#homediv").slideDown(200);
                                currentTest = null;
                            });
                        }
                        else
                            alert("Something went wrong: " + errorMsg);
                    });
                }
            }




            function validateForm(which) {

                if ($("#" + which + "_name").val().trim() == "") {
                    alert("Please provide a name for your study");
                    return false;
                }

                return true;
            }

            function putFormIntoObject(which) {
                var obj = new Object();

                obj.name = $("#" + which + "_name").val();             
                obj.source = $("#" + which + "_source").html();
                obj.description = $("#" + which + "_description").val();
                
                if (which === "viewerform")
                    obj.introduction = $("#" + which + "_intro").html();
                
                return obj;
            }

            function objectToString(obj) {
                var s = obj.name;

                s += " || " + obj.sourcedirectory;
                s += " || " + obj.sourcefile;

                return s;
            }

            function formAction(split) {
                if (split[1] == "done") {
                    if (validateForm(split[0])) {
                        saveUpdates(split[0]);  //save changes to server; update study icon in home; hide study form
                    }
                }
                else if (split[1] == "picksource"){
                    var obj = fileManager.selected;
                    if (typeof obj != undefined && !obj.isDir)
                      $("#" + split[0] + "_source").html(obj.path); 
                } 
                else if (split[1] == "pickintro"){
                    var obj = fileManager.selected;
                    if (typeof obj != undefined && !obj.isDir)
                      $("#" + split[0] + "_intro").html(obj.path); 
                }  
            }





            ////////////////////////////////   TASK PROTO FORM   /////////////////////////////////////////////////////
            function addTaskprotoFormHandlers() {
                $("#taskprotoform_answertype").change(function() {
                    var d = $("#taskprotoform_answertype").val();
                    if (d !== "Interface/Custom") {
                        $("#taskprotoform_answerinterfaces").hide();
                        if (d == "Options(fixed)")
                            $("#taskprotoform_answeroptionssection").show();
                        else
                            $("#taskprotoform_answeroptionssection").hide();

                        if ($("#taskprotoform_answercorrect").val() === "yes") {
                            $("#taskprotoform_answercomputeaccuracy").hide();
                            $("#taskprotoform_answercustomizeaccuracy").show();
                        }
                    }
                    else {
                        $("#taskprotoform_answeroptionssection").hide();
                        $("#taskprotoform_answerinterfaces").show();
                        if ($("#taskprotoform_answercorrect").val() === "yes") {
                            $("#taskprotoform_answercustomizeaccuracy").hide();
                            $("#taskprotoform_answercomputeaccuracy").show();
                        }
                    }
                });

                $("#taskprotoform_answercorrect").change(function() {
                    var d = $("#taskprotoform_answercorrect").val();

                    if (d == "yes") {
                        if ($("#taskprotoform_answertype").val() !== "Interface/Custom") {
                            $("#taskprotoform_answercomputeaccuracy").hide();
                            $("#taskprotoform_answercustomizeaccuracy").show();
                        }
                        else {
                            $("#taskprotoform_answercomputeaccuracy").show();
                            $("#taskprotoform_answercustomizeaccuracy").hide();
                        }
                    }
                    else {
                        $("#taskprotoform_answercomputeaccuracy").hide();
                        $("#taskprotoform_answercustomizeaccuracy").hide();
                    }
                });

            }

            function putTaskprotoDataInForm(which) {

                $("#taskprotoform_loadxml").hide();
                $("#taskprotoform_name").val(which.name);
                $("#taskprotoform_description").val(which.description);
                $("#taskprotoform_question").val(which.question);

                $("#taskprotoform_inputs").html("");
                for (var i = 0; i < which.inputs.length; i++) {
                    var id = createEmptyInputRow();
                    $("#taskprotoform_inputtype_" + id).val(which.inputs[i].typeName);
                    $("#taskprotoform_inputdescription_" + id).val(which.inputs[i].description);
                    $("#taskprotoform_inputshowinvis_" + id).val(which.inputs[i].showInVis);
                    $("#taskprotoform_inputspecinvis_" + id).val(which.inputs[i].specifyInVis);
                    $("#taskprotoform_answercorrect" + id).val(which.inputs[i].correctness);
                }

                $("#taskprotoform_answeroptionssection").hide();
                $("#taskprotoform_answerinterfaces").hide();
                $("#taskprotoform_answercustomizeaccuracy").hide();
                $("#taskprotoform_answercomputeaccuracy").hide();

                $("#taskprotoform_answeroptions").html("");
                $("#taskprotoform_answertype").val(which.answer.type);
                if (which.answer.type === "Options(fixed)") {
                    $("#taskprotoform_answeroptionssection").show();
                    for (var i = which.answer.options.length - 1; i >= 0; i--) {
                        var id = createEmptyAnswerOptionRow();
                        $("#taskprotoform_answeroption_" + id).val(which.answer.options[i]);
                    }
                }
                else if (which.answer.type === "Interface/Custom") {
                    $("#taskprotoform_answerinterfaces").show();
                    $("#taskprotoform_answercustomtypename").val(which.answer.customTypeName);
                }

               
                $("#taskprotoform_answercorrect").val(which.answer.correctness);

                if (which.answer.type != "Options(fixed)") {
                    createEmptyAnswerOptionRow();
                    createEmptyAnswerOptionRow();
                }

                addTaskprotoFormHandlers();
            }

            function isTaskprotoComplete(t) {

                var error = "";

                if (t.name.trim() === "")
                    error += " the task name is empty; ";

                if (t.question.trim() === "")
                    error += " the task question is not specified; ";

              
                for (var i = 0; i < t.inputs.length; i++) {
                    if (t.inputs[i].typeName.trim() === "") {
                        error += " one of the inputs has an unspecified type; ";
                        break;
                    }
                }
                if (t.answer.type === "Interface/Custom" && t.answer.customTypeName.trim() === "")
                    error += " the custom answer type needs to be specified; ";

                if (error.trim() === "")
                    return null;
                else
                    return "It seems that: " + error;
            }



            //saves the information from the taskproto form onto the server
            function saveTaskprotoUpdates(which) {

                var object = putTaskprotoFormIntoObject(which);

                updateTaskprotoDataOnServer(false, object, function(success, errorMsg) {
                    if (success) {
                        currentTaskproto.data = object; //update the actual taskproto data item (currentTaskproto.data)
                        updateTaskprotoIcon(currentTaskproto, object);//update the icon in home (currentViewer)

                        checkAllStudyCompletness();

                        $("#taskprotoform").hide(200, function() {
                            $("#homediv").slideDown(200);
                            currentTaskproto = null;
                        });
                    }
                    else
                        alert("Something went wrong: " + errorMsg);
                });

            }

            function validateTaskprotoForm(which) {

                if ($("#taskprotoform_name").val().trim() == "") {
                    alert("Please provide a name for your task");
                    return false;
                }

                return true;
            }

            function putTaskprotoFormIntoObject(which) {
                var obj = new Object();

                obj.name = $("#taskprotoform_name").val();
                obj.description = $("#taskprotoform_description").val();
                obj.question = $("#taskprotoform_question").val();

                obj.inputs = [];
                $("#taskprotoform_inputs").children().each(function() {
                    var id = $(this).attr("id").split("_")[2];
                    var inputobj = new Object();
                    inputobj.typeName = $("#taskprotoform_inputtype_" + id).val();
                    inputobj.description = $("#taskprotoform_inputdescription_" + id).val();
                    inputobj.showInVis = $("#taskprotoform_inputshowinvis_" + id).val();
                    inputobj.specifyInVis = $("#taskprotoform_inputspecinvis_" + id).val();
                    obj.inputs.push(inputobj);
                });

                obj.answer = new Object();
                obj.answer.type = $("#taskprotoform_answertype").val();
                if (obj.answer.type == "Options(fixed)") {
                    obj.answer.options = [];
                    $("#taskprotoform_answeroptions").find("input").each(function() {
                        obj.answer.options.push($(this).val());
                    });
                }
                else if (obj.answer.type == "Interface/Custom") {
                    obj.answer.customTypeName = $("#taskprotoform_answercustomtypename").val();
                }

                obj.answer.correctness = $("#taskprotoform_answercorrect").val();
                
                return obj;
            }


            function taskprotoFormAction(split) {
             
                if (split[1] == "done") {
                    if (validateTaskprotoForm(split[0])) {
                        saveTaskprotoUpdates(split[0]);  //save changes to server; update icon in home; hide form
                    }
                }
                if (split[1] == "addinput") {
                    createEmptyInputRow();
                }
                if (split[1] === "delinput"){
                    var id = split[2];
                    $("#taskprotoform_inputrow_" + id).remove();
                }
                if (split[1] == "addansweroption"){
                    createEmptyAnswerOptionRow();
                }
                if (split[1] === "delansweroption"){
                    var id = split[2];
                    $("#taskprotoform_answeroptiondiv_"+id).remove();
                }
                if (split[1] == "showxmlform") {
                    $("#taskprotoform_loadxml").toggle();
                }
                if (split[1] == "loadxmlfile") {
                    if ($("#taskprotoform_xmlfile")[0].files.length == 0)
                        alert("Please select a file first");
                    else
                        loadTaskXMLFile($("#taskprotoform_xmlfile")[0].files[0], function(success, msg, taskObject) {
                            putTaskprotoDataInForm(taskObject);
                        });
                }
            }

            function createEmptyInputRow() {
                uniqueInputId++;
                var html = "<div id='taskprotoform_inputrow_" + uniqueInputId + "' style='margin-bottom:5px'>";
                html += "<table style='background-color:rgba(100,100,100,0.2)'><tr>";
                html += "<td style='vertical-align:middle'>&nbsp&nbsp" + ($("#taskprotoform_inputs").children().length + 1) + "&nbsp</td>";
                html += "<td><div class='inputlabel'>Type name</div><input type='text' style='width:60px' id='taskprotoform_inputtype_" + uniqueInputId + "' value='text'></input></td>";
                html += "<td><div class='inputlabel' style='padding-bottom:3px'>Description</div><textarea id=taskprotoform_inputdescription_" + uniqueInputId + " style='width: 200px; height: 25px;'></textarea></td>";
                html += "<td><div class='inputlabel'>Will be Shown in vis</div><select style='width:100%' id='taskprotoform_inputshowinvis_" + uniqueInputId + "'><option value='yes'>yes</option><option value='no' selected>no</option></select></td>";
                html += "<td><div class='inputlabel'>Will be specified in vis</div><select style='width:100%' id='taskprotoform_inputspecinvis_" + uniqueInputId + "'><option value='yes'>yes</option><option value='no' selected>no</option></select><td>";
                html += "<td style='vertical-align:middle'><span class='button' id='taskprotoform_||_delinput_||_" + uniqueInputId + "'> <img src='x-icon.png' height=12 width=12> </span></td>";
                html += "</tr></table></div>";
                $("#taskprotoform_inputs").append(html);

                return uniqueInputId;
            }

            function createEmptyAnswerOptionRow() {
                uniqueAnswerOptionId++;
                var html = "<div style='padding:0px 0px 0px 0px; margin:-3px 0px -3px 0px; style='margin-bottom:5px' id = 'taskprotoform_answeroptiondiv_"  + uniqueAnswerOptionId + "'><input type='text' value='option' id='taskprotoform_answeroption_" + uniqueAnswerOptionId + "'></input>";
                html += "&nbsp&nbsp&nbsp<span class='button' id='taskprotoform_||_delansweroption_||_" + uniqueAnswerOptionId + "'> <img src='x-icon.png' height=12 width=12> </span> </div>";
                $("#taskprotoform_answeroptions").append(html);
                addButtonHandlers();
                return uniqueAnswerOptionId;
            }











            ////////////////////////////////   TASKINSTANCE FORM   /////////////////////////////////////////////////////
            function addTaskinstanceFormHandlers() {


            }

            function putTaskinstanceDataInForm(which) {
                $("#taskinstanceform_loadxml").hide();
                $("#taskinstanceform_taskcreator").hide();

                $("#taskinstanceform_availabletasks").html("");
                $("#taskinstanceform_availabletasks").append($('<option/>', {value: "Select", text: "Select"}));
                for (var i = 0; i < taskprotos.length; i++)
                    $("#taskinstanceform_availabletasks").append($('<option/>', {value: taskprotos[i].data.name, text: taskprotos[i].data.name}));
                $("#taskinstanceform_availabletasks").val(which.taskproto);

                $("#taskinstanceform_availabledatasets").html("");
                $("#taskinstanceform_availabledatasets").append($('<option/>', {value: "no data", text: "no data"}));
                for (var i = 0; i < datasets.length; i++)
                    $("#taskinstanceform_availabledatasets").append($('<option/>', {value: datasets[i].data.name, text: datasets[i].data.name}));
                $("#taskinstanceform_availabledatasets").val(which.dataset);
              

                $("#taskinstanceform_availableviewers").html("");
                $("#taskinstanceform_availableviewers").append($('<option/>', {value: "no viewer", text: "no viewer"}));
                for (var i = 0; i < viewers.length; i++)
                    $("#taskinstanceform_availableviewers").append($('<option/>', {value: viewers[i].data.name, text: viewers[i].data.name}));
                $("#taskinstanceform_availableviewers").val(which.viewer);

                if (which.instanceCount > 0) {
                    $("#taskinstanceform_availabletasks").prop("disabled", true);
                    $("#taskinstanceform_availabledatasets").prop("disabled", true);
                }
                else {
                    $("#taskinstanceform_availabletasks").prop("disabled", false);
                    $("#taskinstanceform_availabledatasets").prop("disabled", false);
                }
            }


            //saves the information from the taskproto form onto the server
            function saveTaskinstanceUpdates(which) {

            }

            function validateTaskinstanceForm(which) {


                return true;
            }

            function putTaskinstanceFormIntoObject(which) {

            }

            function taskInstanceCreated(cnt) {
                currentTaskinstance.data.instanceCount = parseInt(currentTaskinstance.data.instanceCount) + parseInt(cnt);
                $("#taskinstanceform_availabletasks").prop("disabled", true);
                $("#taskinstanceform_availabledatasets").prop("disabled", true);
            }

            function taskinstanceFormAction(split) {
                if (split[1] == "done") {
                    currentTaskinstance.data.taskproto = $("#taskinstanceform_availabletasks").val();
                    currentTaskinstance.data.dataset = $("#taskinstanceform_availabledatasets").val();
                    currentTaskinstance.data.viewer = $("#taskinstanceform_availableviewers").val();
                    
                 
                    if (currentTaskinstance.data.instanceCount > 0) {
                        var index = -1;
                        for (var i = 0; i < taskinstances.length; i++)
                            if (taskinstances[i].data.taskproto === currentTaskinstance.data.taskproto &&
                                    taskinstances[i].data.dataset === currentTaskinstance.data.dataset)
                                index = i;
                       
                        if (index >= 0 && taskinstances[index].data.instanceCount > 0) {
                            alert("It seems you already have tasks of this type for this data set. We will merge the tasks you just created with those you had before.")
                            taskinstances[index].data.instanceCount = currentTaskinstance.data.instanceCount;
                            currentTaskinstance = taskinstances[index];
                        }
                        else {
                            taskinstances.push(currentTaskinstance);
                            $("#homediv_taskinstancesection").append(currentTaskinstance);
                            addHometileHandlers();
                        }
                    }
                    updateTaskinstanceIcon(currentTaskinstance, currentTaskinstance.data);//update the icon in home (currentViewer)
                    $("#taskinstanceform").hide(200, function() {
                        $("#homediv").slideDown(200);
                        currentTaskinstance = null;
                    });
                }
                if (split[1] == "showxmlform") {
                    $("#taskinstanceform_loadxml").toggle();
                }
                if (split[1] == "loadxmlfile") {
                    if ($("#taskinstanceform_jsonfile")[0].files.length == 0)
                        alert("Please select a file first");
                    else {


                        var instanceDetail = {};
                        instanceDetail.taskName = $("#taskinstanceform_availabletasks").val();
                        instanceDetail.dataName = $("#taskinstanceform_availabledatasets").val();
                        instanceDetail.viewerName = $("#taskinstanceform_availableviewers").val();
                        var file = $("#taskinstanceform_jsonfile")[0].files[0];

                        updateTaskInstanceWithAJSONFile(instanceDetail, file, function(success, msg, count) {
                            if (count > 0) {
                                taskInstanceCreated(count);
                                alert("file saved successfully!");
                            } else {
                                alert("Your file did not contain any instance or the format of the file is not accurate");
                            }

                        });
                    }

                }
                if (split[1] == "createtaskinstances") {
                    if ($("#taskinstanceform_availabletasks").val() === "Select")
                        alert("Please select the task you want to create instance of first...");
                    else {

                        createTasksInstancesManually();
                    }
                }

                if (split[1] == "mocktaskcreated")
                    taskInstanceCreated();
                
                if (split[1] === "deltaskinstance"){
                    removeTaskInstance(split[2], split[3], split[4]);
                }
            }


            ////////////////////////////////   RESULTS FORM   /////////////////////////////////////////////////////
            function resultFormAction(split) {

            }

        </script>
    </head>
    <body>

        <div id = "homedivheader">
          <!--  <div style="color: rgb(230,240,255); background-color: rgba(0,0,0,0.15); align:center; padding: 0px 0px 0px 0px; margin:1px -2px 2px -2px; font-weight: bold; letter-spacing: 2px;"> <table width="100%"><tr><td align=center valign=middle><table><tr><td valign=middle><img src="visunitlogo.png" width=40 height=40></img></td><td valign=middle> <span style="margin-top:10px"> VisUnit Home</span> </td></tr></table></td></tr></table></div> -->
          <div style="color: rgb(230,240,255); background-color: rgba(0,0,0,0.15); align:center; padding: 0px 0px 0px 0px; margin:1px -2px 2px -2px; font-weight: bold; letter-spacing: 2px; position:relative; height:50px"><img src="visunitlogo.png" style="position:absolute; left:50%; top:5px; margin-left:-100px" width=40 height=40></img><span style="position:absolute; top:10px;left:50%; margin-left:-55px; height:50px"> VisUnit Home<span></span></div>
        </div>
        <div id = "homediv">
            <div class="ingredientHeader"> Studies </div>
            <div><span id="homediv_studysection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addstudy" title = "Create a new study" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Viewers </div>
            <div><span id="homediv_viewersection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addviewer" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Datasets </div>
            <div><span id="homediv_datasetsection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_adddataset" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Tasks </div>
            <div><span id="homediv_taskprotosection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addtaskproto" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Task instances </div>
            <div><span id="homediv_taskinstancesection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addtaskinstance" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Intros and Thank yous </div>
            <div><span id="homediv_introsection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addintro" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>

            <div class="ingredientHeader"> Standardized Tests </div>
            <div><span id="homediv_testsection"></span>&nbsp&nbsp&nbsp&nbsp<span class="button" id="home_||_addtest" style="padding:3px 3px 0px 3px"><img src="plus-icon.png" width=20px height=20px></img></span></div><br>
        </div>


        <div id = "studyform">
            <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Study configuration </div>
            <div id="studyform_cannotbeedited" style="text-align: center; font-weight: bold"> You cannot edit this study anymore since you've collected results for it.</div>
            <div><span class="button" id="studyform_||_done_||_1"> Done <span></div>
                        <br><br>

                        <div> <div class = "inputdiv"> 
                                <div class="fieldlabel">Study name</div>
                                <input type="text" id="studyform_name"></input>
                            </div></div>

                        <table><tr>
                        <td><table><tr>
                         <td><div style='margin-right:0px; padding-right:0px'><table><tr>
                            <td><div class = "inputdiv" style='margin-right:0px'>	
                                <table style="width:100%"><tr>
                                    <td><div style='margin-bottom:10px; margin-right:0px'><span class="fieldlabel"> Viewers<span> </div></td>
                                    <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_datasets_help">?</span></td>
                                </tr></table>	

                                <div id="studyform_viewers">
                                </div>

                                <p></p>
                                <div> <span class="button" id="studyform_||_addviewer"> <img src='plus-icon.png' height=12 width=12> </span></div>
                            </div></td>                           
                        </tr></table></div></td>
                        
                        <td><div><table><tr>
                            <td><div class = "inputdiv" style='margin-left:-10px; margin-right:-35px'> 	
                                <table style="width:100%"><tr>
                                    <td><div style='margin-bottom:10px; margin-left:0px; margin-right:0px'><span class="fieldlabel"> Datasets <span></div></td>
                                    <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_datasets_help">?</span></td>
                                </tr></table>	

                                <div id="studyform_datasets">
                                </div>

                                <p></p>
                                <div> <span class="button" id="studyform_||_adddataset"> <img src='plus-icon.png' height=12 width=12> </span></div>
                            </div></td>

                        </tr></table></div></td>
                        </tr></table></td>
                                                    <td>
                                <div class = "help" id="studyform_datasets_help_"> 
                                    Some dataset help here 
                                </div>
                            </td>
                            </tr>
                            
                            
                            
                            <tr><td>
                            <div><table><tr>
                                                                                                                            <td><div class = "inputdiv"> 	
                                                                                                                                    <table style="width:100%"><tr>
                                                                                                                                            <td><div style='margin-bottom:10px'><span class="fieldlabel"> Tasks </span></div></td>
                                                                                                                                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_tasks_help">?</span></td>
                                                                                                                                        </tr></table>	

                                                                                                                                    <div id="studyform_tasks">
                                                                                                                                    </div>

                                                                                                                                    <p></p>
                                                                                                                                    <div> <span class="button" id="studyform_||_addtask"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                </div></td>

                                                                                                                            <td>
                                                                                                                                <div class = "help" id="studyform_tasks_help_"> 
                                                                                                                                    Some tasks help here 
                                                                                                                                </div>
                                                                                                                            </td>
                                                                                                                        </tr></table></div>    
                            </td></tr>
                           
                            
                            
                            
                            
                            
                        
                        <tr><td><div><table width='100%'><tr>
                            <td><div style='width:100%' class = "inputdiv"> 	
                                <table style="width:100%"><tr>
                                    <td><div style='margin-bottom:10px'><span class="fieldlabel"> Conditions <span></div></td>
                                    <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_conditions_help">?</span></td>
                                </tr></table>	

                                <div id="studyform_conditions" style="margin-left:10px">
                                    <div style="margin-top:-15px"><font style="font-style: italic; font-size:11px"> select some viewers and datasets</font></div>
                                </div>
                                
                            </div></td>
                            
                    </tr></table></div></td>
                    <td>
                                <div class = "help" id="studyform_conditions_help_"> 
                                    Some conditions help here 
                                </div>
                            </td>
                            </tr></table>
                        


                        <div><table><tr>
                            <td><div class = "inputdiv"> 
                                <table style="width:100%"><tr>
                                    <td>
                                        <div class="fieldlabel" style="margin-bottom:5px">Experimental design </div>
                                        <table><tr>
                                                <td>
                                                    <div class="inputrow" style="padding:5px 5px 5px 5px"><div> Viewers </div>
                                                        <select id="studyform_viewerdesign" style="width:100%" onchange="viewerDesignChanged()">
                                                        <option selected value = "Between subjects">Between subjects</option>
                                                        <option value = "Within subjects (balanced)">Within subjects (balanced)</option>
                                                        <option value = "Within subjects (fixed order)">Within subjects (fixed order)</option>
                                                        <option value = "Within subjects (random order)">Within subjects (random order)</option>
                                                    </select></div>
                                                </td>
                                                <td>
                                                    <div class="inputrow" style="padding:5px 5px 5px 5px"><div> Datasets </div>
                                                    <select id="studyform_datasetdesign" style="width:100%" onchange="datasetDesignChanged()">
                                                        <option selected value = "Between subjects">Between subjects</option>
                                                        <option value = "Within subjects (balanced)">Within subjects (balanced)</option>
                                                        <option value = "Within subjects (fixed order)">Within subjects (fixed order)</option>
                                                        <option value = "Within subjects (random order)">Within subjects (random order)</option>
                                                    </select></div>
                                                </td>
                                                <td>
                                                    <div class="inputrow" style="padding:5px 5px 5px 5px"><div> Tasks </div>
                                                    <select id="studyform_taskdesign" style="width:100%" onchange="taskDesignChanged()">
                                                        <option selected value = "Between subjects">Between subjects</option>
                                                        <option value = "Within subjects (balanced)">Within subjects (balanced)</option>
                                                        <option value = "Within subjects (fixed order)">Within subjects (fixed order)</option>
                                                        <option value = "Within subjects (random order)">Within subjects (random order)</option>
                                                    </select></div>
                                                </td>
                                                <td>
                                                    <div class="inputrow" style="padding:5px 5px 5px 5px"><div> Order </div>
                                                    <select id="studyform_order" style="width:100%" onchange="orderChanged()">
                                                        <option selected value = "Viewer,Data,Task">Viewer, data, task</option>
                                                        <option value = "Viewer,Task,Data">Task,data,viewer</option>
                                                        <option value = "Data,Viewer,Task">Data,viewer,task</option>
                                                        <option value = "Data,Task,Viewer">Data,task,viewer</option>
                                                        <option value = "Task,Data,Viewer">Task,data,viewer</option>
                                                        <option value = "Task,Viewer,Data">Task,viewer,data</option>                                    
                                                     </select></div>
                                                </td>
                                        </tr></table>
                                         <div class="fieldlabel" style="margin-top:10px">Condition grouping and ordering </div>
                                         <div id="studyform_groupings" style="margin-left:10px">
                                             <div style="font-style: italic; font-size:11px"> select some viewers and datasets</div>
                                         </div>
                                                
                                    </td>
                                    <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_viewerdesign_help">?</span></td>
                                </tr></table>
                            </div></td>

                            <td><div>
                                <div class = "help" id="studyform_viewerdesign_help_"> 
                                    Some experimental design for viewers help here 
                                </div>
                            </td>
                        </tr></table></div>

                                

                        <div><table><tr>
                            <td><div class = "inputdiv"> 	
                                <table style="width:100%"><tr>
                                    <td><div style='margin-bottom:10px'><span class="fieldlabel"> Number of participants </span></div></td>
                                    <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_tasks_help">?</span></td>
                                </tr></table>
                                    
                                <div class="inputrow">
                                    <input type="number" id="studyform_nrusers" value="10"></input>
                                </div>
                                    
                                <p></p>
                            </div></td>
                            <td>
                                <div class = "help" id="studyform_nrusers_help_"> 
                                    Some user count help here 
                                </div>
                            </td>
                        </tr></table></div>
          



                                                                                                                


                                                                                                                <div><table><tr>
                                                                                                                            <td><div class = "inputdiv"> 	
                                                                                                                                    <table style="width:100%"><tr>
                                                                                                                                            <td><div style='margin-bottom:10px'><span class="fieldlabel"> Entry tasks/questions </span></div></td>
                                                                                                                                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_entrytasks_help">?</span></td>
                                                                                                                                        </tr></table>	

                                                                                                                                    <div id="studyform_entrytasks">
                                                                                                                                    </div>

                                                                                                                                    <p></p>
                                                                                                                                    <div> <span class="button" id="studyform_||_addentrytask"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                </div></td>

                                                                                                                            <td>
                                                                                                                                <div class = "help" id="studyform_entrytasks_help_"> 
                                                                                                                                    Some entry tasks help here 
                                                                                                                                </div>
                                                                                                                            </td>
                                                                                                                        </tr></table></div>


                                                                                                                <div><table><tr>
                                                                                                                            <td><div class = "inputdiv"> 	
                                                                                                                                    <table style="width:100%"><tr>
                                                                                                                                            <td><div style='margin-bottom:10px'><span class="fieldlabel"> Exit tasks/questions </span></div></td>
                                                                                                                                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_exittasks_help">?</span></td>
                                                                                                                                        </tr></table>	

                                                                                                                                    <div id="studyform_exittasks">
                                                                                                                                    </div>

                                                                                                                                    <p></p>
                                                                                                                                    <div> <span class="button" id="studyform_||_addexittask"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                </div></td>

                                                                                                                            <td>
                                                                                                                                <div class = "help" id="studyform_exittasks_help_"> 
                                                                                                                                    Some exit tasks help here 
                                                                                                                                </div>
                                                                                                                            </td>
                                                                                                                        </tr></table></div>



                                                                                                                <div><table><tr>
                                                                                                                            <td><div class = "inputdiv"> 	
                                                                                                                                    <table style="width:100%"><tr>
                                                                                                                                            <td><div style='margin-bottom:10px'><span class="fieldlabel"> Intros <span> </div></td>
                                                                                                                                                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_intros_help">?</span></td>
                                                                                                                                                            </tr></table>	

                                                                                                                                                            <div id="studyform_intros">
                                                                                                                                                            </div>

                                                                                                                                                            <p></p>
                                                                                                                                                            <div> <span class="button" id="studyform_||_addintro"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                                            </div></td>

                                                                                                                                                            <td>
                                                                                                                                                                <div class = "help" id="studyform_intros_help_"> 
                                                                                                                                                                    Some intros help here 
                                                                                                                                                                </div>
                                                                                                                                                            </td>
                                                                                                                                                            </tr></table></div>
                                
                                                                                                                             <div><table><tr>
                                                                                                                            <td><div class = "inputdiv"> 	
                                                                                                                                    <table style="width:100%"><tr>
                                                                                                                                            <td><div style='margin-bottom:10px'><span class="fieldlabel"> Thank you <span> </div></td>
                                                                                                                                                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_thankyous_help">?</span></td>
                                                                                                                                                            </tr></table>	

                                                                                                                                                            <div id="studyform_thankyous">
                                                                                                                                                                <select id="studyform_thankyou">
                                                                                                                                                                    <option value="Default" selected>Default</option>
                                                                                                                                                            </div>
                                                                                                                                                            
                                                                                                                                                            <td>
                                                                                                                                                                <div class = "help" id="studyform_thankyous_help_"> 
                                                                                                                                                                    Some intros help here 
                                                                                                                                                                </div>
                                                                                                                                                            </td>
                                                                                                                                                            </tr></table></div>



                                                                                                                                                            <div><table><tr>
                                                                                                                                                                        <td><div class = "inputdiv"> 	
                                                                                                                                                                                <table style="width:100%"><tr>
                                                                                                                                                                                        <td><div style='margin-bottom:10px'><span class="fieldlabel"> Standardized tests <span> </div></td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_tests_help">?</span></td>
                                                                                                                                                                                                        </tr></table>	

                                                                                                                                                                                                        <div id="studyform_tests">
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <p></p>
                                                                                                                                                                                                        <div> <span class="button" id="studyform_||_addtest"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                                                                                        </div></td>

                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="studyform_tests_help_"> 
                                                                                                                                                                                                        Some tests help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>
                                




                                                                                                                                                                                                        <div><table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv"> 
                                                                                                                                                                                                        <table><tr>
                                                                                                                                                                                                        <td><div class="fieldlabel">Width(px)</div> <input type="number" min=1 id="studyform_width" value=800 style="width:100%"></td>
                                                                                                                                                                                                        <td><div class="fieldlabel">Height(px)</div> <input type="number" min=1 id="studyform_height" value=600 style="width:100%"></td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_size_help">?</span></td>
                                                                                                                                                                                                        </tr></table>
                                                                                                                                                                                                        </div></td>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="studyform_size_help_"> 
                                                                                                                                                                                                        Some tests help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>

                                                                                                                                                                                                        <div><table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv"> 
                                                                                                                                                                                                        <table><tr>
                                                                                                                                                                                                        <td><span class="button" id="studyform_||_demo"> Demo </span></td>
                                                                                                                                                                                                        <td><span class="button" id="studyform_||_getalink"> Get a link </span></td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="studyform_demolink_help">?</span></td>
                                                                                                                                                                                                        </tr></table>
                                                                                                                                                                                                        </div></td>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="studyform_demolink_help_"> 
                                                                                                                                                                                                        Some demo and lik help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>		


                                                                                                                                                                                                        <br><br>
                                                                                                                                                                                                        <div><span class="button" id="studyform_||_done_||_2"> Done <span></div>


                                                                                                                                                                                                        </div>


                        
                        
                        
                        


        <div id="viewerform">
            <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Viewer configuration </div>
                <div><span class="button" id="viewerform_||_done_||_1"> Done <span></div>
                    <div><table><tr>
                        <td><div class = "inputdiv"> 
                            <table style="width:100%"><tr>
                                <td>
                                    <div class="fieldlabel">Name</div>
                                    <input type="text" id="viewerform_name">
                                </td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="viewerform_name_help">?</span></td>
                            </tr></table>
                        </div></td>
                        <td>
                            <div class = "help" id="viewerform_name_help_"> 
                                Some viewer name help here 
                            </div>
                        </td>
                    </tr></table></div>
                            
                    <div><table><tr>
                        <td><div class = "inputdiv"> 
                            <table style="width:100%"><tr>
                                <td>
                                    <div class="fieldlabel">Description</div>
                                        <textarea id="viewerform_description" style="width: 200px; height: 50px;"></textarea>
                                </td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="viewerform_description_help">?</span></td>
                            </tr></table>
                        </div></td>
                        <td>
                            <div class = "help" id="viewerform_description_help_"> 
                               Some viewer description help here 
                            </div>
                        </td>
                    </tr></table></div>

                    <div><table><tr>
                        <td><div class = "inputdiv"> 	
                            <table style="width:100%"><tr>
                                <td><div style='margin-bottom:10px'><span class="fieldlabel"> Viewer source <span> </div></td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="viewerform_source_help">?</span></td>
                            </tr></table>
                            <div>
                                <div style="font-size:12px"> 
                                    <i>select file below, then press button </i>
                                    <span class="button" id="viewerform_||_picksource"><img src="folder-icon.png" width="12" height="12"></span>
                                </div>
                                <div id="viewerform_source" style="font-size:13px; margin-left:7px"></div>
                            </div></div></td>
                        <td>
                            <div class = "help" id="viewerform_source_help_"> 
                                Some viewer source help here 
                            </div>
                        </td>
                    </tr></table></div>
                            
                    <div><table><tr>
                        <td><div class = "inputdiv"> 	
                            <table style="width:100%"><tr>
                                <td><div style='margin-bottom:10px'><span class="fieldlabel"> Viewer introduction <span> </div></td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="viewerform_intro_help">?</span></td>
                            </tr></table>
                            <div>
                                <div style="font-size:12px"> 
                                    <i>select file below, then press button </i>
                                    <span class="button" id="viewerform_||_pickintro"><img src="folder-icon.png" width="12" height="12"></span>
                                </div>
                                <div style="font-size:13px; margin-left:7px" id="viewerform_intro"></div>
                            </div></div></td>
                        <td>
                            <div class = "help" id="viewerform_intro_help_"> 
                                Some intro help here 
                            </div>
                        </td>
                    </tr></table></div>                            

                    <div id="viewerform_addstuff"> 
                        <div id="adddirform"></div>
                    </div>
                            
                <div><span class="button" id="viewerform_||_done_||_2"> Done <span></div>
             </div>









            <div id="datasetform">
                <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Dataset configuration </div>
                    <div><span class="button" id="datasetform_||_done_||_1"> Done <span></div>
                    <div><table><tr>
                        <td><div class = "inputdiv"> 
                            <table style="width:100%"><tr>
                                <td>
                                    <div class="fieldlabel">Name</div>
                                    <input type="text" id="datasetform_name"></input>
                                </td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="datasetform_name_help">?</span></td>
                            </tr></table>
                        </div></td>
                        <td>
                            <div class = "help" id="datasetform_name_help_"> 
                                Some dataset name help here 
                            </div>
                        </td>
                    </tr></table></div>
                                
                <div><table><tr>
                    <td><div class = "inputdiv"> 
                        <table style="width:100%"><tr>
                            <td>
                                <div class="fieldlabel">Description</div>
                                <textarea id="datasetform_description" style="width: 200px; height: 50px;"></textarea>
                            </td>
                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="datasetform_description_help">?</span></td>
                        </tr></table>
                    </div></td>
                    <td>
                        <div class = "help" id="datasetform_description_help_"> 
                            Some dataset description help here 
                        </div>
                    </td>
                </tr></table></div>

                    <div><table><tr>
                        <td><div class = "inputdiv"> 	
                            <table style="width:100%"><tr>
                                <td><div style='margin-bottom:10px'><span class="fieldlabel"> Dataset source <span> </div></td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="datasetform_source_help">?</span></td>
                            </tr></table>
                            <div>
                                <div style="font-size:12px"> 
                                    <i>select file below, then press button </i>
                                    <span class="button" id="datasetform_||_picksource"><img src="folder-icon.png" width="12" height="12"></span>
                                </div>
                                <div id="datasetform_source" style="font-size:13px; margin-left:7px"></div>
                            </div></div></td>
                        <td>
                            <div class = "help" id="datasetform_source_help_"> 
                                Some dataset source help here 
                            </div>
                        </td>
                    </tr></table></div>

                <div id="datasetform_addstuff">
                </div>
                <div><span class="button" id="datasetform_||_done_||_2"> Done <span></div>
            </div>








                                                                                                                                                                                                        <div id="taskprotoform">
                                                                                                                                                                                                        <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Task configuration </div>
                                                                                                                                                                                                        <div><span class="button" id="taskprotoform_||_done_||_1"> Done <span></div>
                                                                                                                                                                                                        <br>

                                                                                                                                                                                                        <div class="inputdiv" style="margin-left:200px;">
                                                                                                                                                                                                        <div class="button" id="taskprotoform_||_showxmlform" style="width:220px; text-align:center; margin-top:0px; border-radius:1px; font-size:14px; opacity:0.5">Create by uploading an XML file</div>
                                                                                                                                                                                                        <div id="taskprotoform_loadxml">
                                                                                                                                                                                                        <input type="file" id="taskprotoform_xmlfile"></input>
                                                                                                                                                                                                        <span class="button" id="taskprotoform_||_loadxmlfile">go!</span>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        <br><br>

                                                                                                                                                                                                        <div> <div class = "inputdiv"> <div class='inputlabel'>Name</div> <input type="text" id="taskprotoform_name"></div></div>
                                                                                                                                                                                                        <div> <div class = "inputdiv"> <div class='inputlabel' style='padding-bottom:3px';>Description</div><textarea id="taskprotoform_description" style="width: 200px; height: 50px;"></textarea></div></div>

                                                                                                                                                                                                        <div> <div class = "inputdiv">
                                                                                                                                                                                                        <div style="width:500px; padding-bottom:3px" class="inputlabel">Question or instruction as it will be shown to users. Parts of the question
                                                                                                                                                                                                        can be dynamic (i.e., change between individual instances of this task). 
                                                                                                                                                                                                        where the numbers represent an index in the list of inputs.</div> 
                                                                                                                                                                                                        <div><textarea id="taskprotoform_question" style="width: 200px; height: 50px;"></textarea></div>
                                                                                                                                                                                                        </div></div>


                                                                                                                                                                                                        <table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv">
                                                                                                                                                                                                        <table style="width:100%"><tr><td><div style='margin-bottom:10px'> Inputs </div></td><td style="text-align:right; padding-right:0px"><span class="questionmark" id="taskprotoform_inputs_help">?</span></td></tr></table>
                                                                                                                                                                                                        <div id="taskprotoform_inputs"></div>
                                                                                                                                                                                                        <div> <span class="button" id="taskprotoform_||_addinput"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                                                                                        </div></td>
                                                                                                                                                                                                        <td><div class = "help" id="taskprotoform_inputs_help_"> 
                                                                                                                                                                                                        Some input help here 
                                                                                                                                                                                                        </div></td>
                                                                                                                                                                                                        </tr></table>



                                                                                                                                                                                                        <br>
                                                                                                                                                                                                        <table><tr><td><div class = "inputdiv">
                                                                                                                                                                                                        <table style="width:100%"><tr><td><div style='margin-bottom:10px'> Answer </div></td><td style="text-align:right; padding-right:0px"><span class="questionmark" id="taskprotoform_answer_help">?</span></td></tr></table>

                                                                                                                                                                                                        <div class='inputlabel'> Type </div> 
                                                                                                                                                                                                        <select id="taskprotoform_answertype">
                                                                                                                                                                                                        <option value="Number" selected>Number</option>
                                                                                                                                                                                                        <option value="Text">Text</option>
                                                                                                                                                                                                        <option value="Options(fixed)">Options(fixed)</option>
                                                                                                                                                                                                        <option value="Options(dynamic)">Options(dynamic)</option>
                                                                                                                                                                                                        <option value="Interface/Custom">Interface/Custom</option>
                                                                                                                                                                                                        </select>


                                                                                                                                                                                                        <div id="taskprotoform_answeroptionssection" style='margin-left:10px'>
                                                                                                                                                                                                        <div id="taskprotoform_answeroptions"></div>
                                                                                                                                                                                                        <div> <span class="button" id="taskprotoform_||_addansweroption"> <img src='plus-icon.png' height=12 width=12> </span></div>
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <div id="taskprotoform_answerinterfaces" style='margin-left:20px'>
                                                                                                                                                                                                        Custom type name: <input type="text" id="taskprotoform_answercustomtypename"></input>
                                                                                                                                                                                                        </div>



                                                                                                                                                                                                        <div class="inputlabel"  style='margin-top:10px'>	Correctness? </div>
                                                                                                                                                                                                        <select id="taskprotoform_answercorrect" style='width:100%'><option value="no">no</option><option value="yes">yes</option></select>

                                                                                                                                                                                                        <div id="taskprotoform_answercustomizeaccuracy">
                                                                                                                                                                                                        Check our documentation for how to customize the way the error between the correct answer and the provide answer is computed.
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <div id="taskprotoform_answercomputeaccuracy">
                                                                                                                                                                                                        Make sure to add to your viewer a function that computes the error between the correct answer and the provided answer (check our documentation).
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        </div></td>

                                                                                                                                                                                                        <td> 
                                                                                                                                                                                                        <div class="help" id="taskprotoform_answer_help_">Some help stuff here that ends with a</div>
                                                                                                                                                                                                        </td>

                                                                                                                                                                                                        </tr></table>

                                                                                                                                                                                                        <div><span class="button" id="taskprotoform_||_done_||_2"> Done <span></div>
                                                                                                                                                                                                        </div></td>











                                                                                                                                                                                                        <div id="taskinstanceform">
                                                                                                                                                                                                        <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Create task instances </div>
                                                                                                                                                                                                        <div><span class="button" id="taskinstanceform_||_done_||_1"> Done <span></div>
                                                                                                                                                                                                        
                                                                                                                                                                                                        
                                                                                                                                                                                                        <div><div class = "inputdiv"> 
                                                                                                                                                                                                        <div class='inputlabel'>Task</div>
                                                                                                                                                                                                        <select id="taskinstanceform_availabletasks">
                                                                                                                                                                                                        </select>
                                                                                                                                                                                                        </div></div>

                                                                                                                                                                                                        <div><div class = "inputdiv">
                                                                                                                                                                                                        <div class='inputlabel'>Dataset</div>
                                                                                                                                                                                                        <select id="taskinstanceform_availabledatasets"> 
                                                                                                                                                                                                        </select>
                                                                                                                                                                                                        </div></div>

                                                                                                                                                                                                        <div><div class = "inputdiv"> 
                                                                                                                                                                                                        <div class='inputlabel'>Viewer</div>
                                                                                                                                                                                                        <select id="taskinstanceform_availableviewers">
                                                                                                                                                                                                        </select>
                                                                                                                                                                                                        </div></div>


                                                                                                                                                                                                        <br>
                                                                                                                                                                                                        <table><tr>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class="inputdiv">
                                                                                                                                                                                                        <div class="button" id="taskinstanceform_||_createtaskinstances" style="width:220px; text-align:center; margin-top:0px; border-radius:1px; font-size:14px; opacity:0.5">Create task instances interactively</div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        or
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class="inputdiv" style="margin-left:0px">
                                                                                                                                                                                                        <div class="button" id="taskinstanceform_||_showxmlform" style="width:220px; text-align:center; margin-top:0px; border-radius:1px; font-size:14px; opacity:0.5">Add task instances by uploading a JSON file</div>
                                                                                                                                                                                                        <div id="taskinstanceform_loadxml">
                                                                                                                                                                                                        <input type="file" id="taskinstanceform_jsonfile"></input>
                                                                                                                                                                                                        <span class="button" id="taskinstanceform_||_loadxmlfile">go!</span>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table>

            <div id="taskinstanceform_taskcreator">
                <br>
                <div id="taskInstanceViewerFrameDiv"></div>
                <!-- managing window -->
                <div id="propControl" style='background-color:rgb(242,250,255);font-size:12px'> 
                    <div style='background-color:rgba(0,0,0,0.1); font-size:18px; margin-bottom: 15px; padding-left: 5px'> <span id='taskinstanceform_taskName'></span>&nbsp:&nbsp instance #<span id="taskInstanceNumber">1</span></div>
                    <div> <b> Description:</b> <span id='taskinstanceform_taskDescription' style='font-style:italic'></span></div>
                    <div> <b> Question:</b> <span id='taskinstanceform_taskQuestion' style='font-style:italic'></span></div>
                    <div id="inputsAndAnswers">
                        <div id='taskinstanceform_nrinputsanswers' style='margin-top:20px; margin-bottom: 5px'></div>
                        <hr />
                        <div id='taskinstanceform_inputiofn' style='margin-top:-5px; margin-bottom:5px; font-weight:bold; text-align:right'></div> <!-- Input 2 of 3 -->

                        <div id="inputsDiv">
                            <div><b>Type:</b> <span id="taskinstanceform_inputType" style='font-style:italic'></span></div>
                            <div><b>Description:</b> <span id="taskinstanceform_inputDescription" style='font-style:italic'></span></div>
                            <!--Specify how this input will be provided -->
                            <div id="input-from-visualization" style="display: none; margin-left:10px; margin-top:10px">               
                                <div>Select the input in the visualization <span id='taskinstanceform_selecthelp' style='font-style:italic'></span>
                                    <span id="selectedInputSpan">; (string value of currently selected input is '<span id="selectedInput"></span>')</span></div>
                            </div>
                            <div id="input-from-typing" style="display: none; margin-left: 10px;  margin-top:10px">
                                Provide this input here:  <input type="text" size="25" id="typedInput"/>
                            </div>
                            <p id="next-input-button" style="display:none;">  
                                <input type="button" value="Save Input" onclick="saveInputs();"/>                 
                            </p>
                            <p id="provide-answer-button" style="display:none;">
                                 <input type="button" value="Save Input" onclick="doneWithInputs();"/> 
                            </p>
                        </div>
                        
                        <div id="answersDiv" style="display:none;">
                            <div id="answer-from-visualization" style="display:none;">
                                <div>Select the answer in the visualization <span id='taskinstanceform_selectAnswerHelp' style='font-style:italic'></span>
                                    <span id="selectedAnswerSpan">; (string value of currently selected answer is '<span id="selectedAnswerFromVis"></span>')</span></div>
                            </div>
                            <div id="answer-from-typing" style="display: none; margin-left: 10px;  margin-top:10px">
                                Type the answer here:  <input type="text" size="25" id="typedAnswer"/>
                            </div>
                            <input type="hidden" id="providedAnswer" value="" />
                            <div id="dynamic-optionsDiv" style="display:none;">                    
                                Provide all the options and select the correct option.
                                <div id="optionsDiv">      
                                    <div id="div_option1">
                                        <p>
                                            <input type="radio" id="optionRadio1" name="answerOption" value="1" onclick="setDynamicOptionAnswer(this)"/>
                                            <input type="text" id="option1" size="15"/>
                                        </p>
                                    </div>
                                    <div id="div_option2">
                                        <p>
                                            <input type="radio" id="optionRadio2" name="answerOption" value="2" onclick="setDynamicOptionAnswer(this)"/>
                                            <input type="text" id="option2" size="15"/> 
                                        </p>
                                    </div>                                    
                                    <input type="hidden" value="" id="selectedOption" />
                                </div>
                                
                                <div style="margin-left:10px; margin-top:-5px">
                                    <input id="taskinstanceform_addoption" type="button" value="add" onclick="addMoreDynamicOptions()"/>
                                    <input id="taskinstanceform_deloption" type="button" value="del" onclick="removeDynamicOption()"/>
                                    <input type="hidden" value="2" id="numberOfOptions"/>
                                </div>
                            </div>
                            <div id="answersDivContainer" style="display:none;">
                                <div>
                                    <input type="hidden" id= "answerMedium" value=""/>
                                    <div id="interfaceAnswerDiv" style="display:none;">
                                    </div>
                                    <div id="answerSelectionDiv" style="display:none">
                                    </div>
                                </div>
                            </div>  
                            
                            <div style="margin-top:15px"><input type="button" value="Save Answer" onclick="saveAnswer()"/></div>
                            
                        </div>
                        <div id="noNeedForTaskInstances" style="display:none;">
                                <strong> NOTE:  </strong>
                                    Since this task does not require any input,
                                    and does not have a correct answer, there is no need to create 
                                    task instance for this task.
                        </div>
                        <div id ="taskinstanceform_instanceComplete" style="display:none; margin-top:20px"> Instance complete. Save it to continue to the next one.</div>
                        <div>  <input type="button" id="nextInstance" value="Save Instance" onclick="saveInstance();" style="display:none; margin-top:10px"/></div>
                    </div>
                </div>
            </div>

                                                                                                                                                                                                        <br>
                                                                                                                                                                                                        <div><span class="button" id="taskinstanceform_||_done_||_2"> Done <span></div>
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <div id="resultsform">
                                                                                                                                                                                                        Results form
                                                                                                                                                                                                        </div>










                                                                                                                                                                                                        <div id="introform">
                                                                                                                                                                                                        <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Intro configuration </div>
                                                                                                                                                                                                        <div><span class="button" id="introform_||_done_||_1"> Done <span></div>


                                                                                                                                                                                                        <div><table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv"> 
                                                                                                                                                                                                        <table style="width:100%"><tr>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class="fieldlabel">Name</div>
                                                                                                                                                                                                        <input type="text" id="introform_name"></input>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="introform_name_help">?</span></td>
                                                                                                                                                                                                        </tr></table>
                                                                                                                                                                                                        </div></td>

                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="introform_name_help_"> 
                                                                                                                                                                                                        Some intro name help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>


                                                                                                                                                                                                        <div><table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv"> 
                                                                                                                                                                                                        <table style="width:100%"><tr>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class="fieldlabel">Description</div>
                                                                                                                                                                                                        <textarea id="introform_description" style="width: 200px; height: 50px;"></textarea>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="introform_description_help">?</span></td>
                                                                                                                                                                                                        </tr></table>
                                                                                                                                                                                                        </div></td>

                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="introform_description_help_"> 
                                                                                                                                                                                                        Some intro description help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>


                    <div><table><tr>
                        <td><div class = "inputdiv"> 	
                            <table style="width:100%"><tr>
                                <td><div style='margin-bottom:10px'><span class="fieldlabel"> Introduction source <span> </div></td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="introform_source_help">?</span></td>
                            </tr></table>
                            <div>
                                <div style="font-size:12px"> 
                                    <i>select file below, then press button </i>
                                    <span class="button" id="introform_||_picksource"><img src="folder-icon.png" width="12" height="12"></span>
                                </div>
                                <div id="introform_source" style="font-size:13px; margin-left:7px"></div>
                            </div></div></td>
                        <td>
                            <div class = "help" id="introform_source_help_"> 
                                Some intro source help here 
                            </div>
                        </td>
                    </tr></table></div>
                                                                                                                                                                                                        



                                                                                                                                                                                                        <div id="introform_addstuff">
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <div><span class="button" id="introform_||_done_||_2"> Done <span></div>
                                                                                                                                                                                                        </div>









                                                                                                                                                                                                        <div id="testform">
                                                                                                                                                                                                        <div style="background-color: rgba(100,100,100,0.2); text-align:center; margin:-2px -2px 10px -2px"> Standardized test configuration </div>
                                                                                                                                                                                                        <div><span class="button" id="testform_||_done_||_1"> Done <span></div>


                                                                                                                                                                                                        <div><table><tr>
                                                                                                                                                                                                        <td><div class = "inputdiv"> 
                                                                                                                                                                                                        <table style="width:100%"><tr>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class="fieldlabel">Name</div>
                                                                                                                                                                                                        <input type="text" id="testform_name"></input>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td style="text-align:right; padding-right:0px"><span class="questionmark" id="testform_name_help">?</span></td>
                                                                                                                                                                                                        </tr></table>
                                                                                                                                                                                                        </div></td>

                                                                                                                                                                                                        <td>
                                                                                                                                                                                                        <div class = "help" id="testform_name_help_"> 
                                                                                                                                                                                                        Some dataset name help here 
                                                                                                                                                                                                        </div>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        </tr></table></div>

                                                                                                                                                                                                                        <div><table><tr>
                <td><div class = "inputdiv"> 
                        <table style="width:100%"><tr>
                            <td>
                                <div class="fieldlabel">Description</div>
                                <textarea id="testform_description" style="width: 200px; height: 50px;"></textarea>
                            </td>
                            <td style="text-align:right; padding-right:0px"><span class="questionmark" id="testform_description_help">?</span></td>
                        </tr></table>
                    </div></td>
                    <td>
                        <div class = "help" id="testform_description_help_"> 
                            Some test description help here 
                        </div>
                    </td>
                </tr></table></div>

                    <div><table><tr>
                        <td><div class = "inputdiv"> 	
                            <table style="width:100%"><tr>
                                <td><div style='margin-bottom:10px'><span class="fieldlabel"> Test source <span> </div></td>
                                <td style="text-align:right; padding-right:0px"><span class="questionmark" id="testform_source_help">?</span></td>
                            </tr></table>
                            <div>
                                <div style="font-size:12px"> 
                                    <i>select file below, then press button </i>
                                    <span class="button" id="testform_||_picksource"><img src="folder-icon.png" width="12" height="12"></span>
                                </div>
                                <div id="testform_source" style="font-size:13px; margin-left:7px"></div>
                            </div></div></td>
                        <td>
                            <div class = "help" id="testform_source_help_"> 
                                Some test source help here 
                            </div>
                        </td>
                    </tr></table></div>                                                                                                                                                                                                        


                                                                                                                                                                                                        


                                                                                                                                                                                                        <div id="testform_addstuff">
                                                                                                                                                                                                        </div>

                                                                                                                                                                                                        <div><span class="button" id="testform_||_done_||_2"> Done <span></div>
                                                                                                                                                                                                        </div>






                                                                                                                                                                                                        </body>
                                                                                                                                                                                                        </html>